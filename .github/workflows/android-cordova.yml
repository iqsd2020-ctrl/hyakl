name: Build Android APK (Cordova)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.11.1"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK packages
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager "platform-tools" "platforms;android-35" "build-tools;35.0.0"

      - name: Install Cordova CLI
        run: npm install -g cordova@12

      - name: Decode Android signing files
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          mkdir -p .secrets
          printf '%s' "$ANDROID_KEYSTORE_BASE64" | tr -d '\r\n\t ' | base64 -d > .secrets/hyakl-release.jks || { echo "ANDROID_KEYSTORE_BASE64 is invalid"; exit 1; }

      - name: Create temporary Cordova project
        run: |
          rm -rf app
          npx cordova create app com.iqsd2020.hyakl "هياكل النور"

          cat > app/config.xml <<'EOF'
          <?xml version='1.0' encoding='utf-8'?>
          <widget id="com.iqsd2020.hyakl" version="1.0.0" xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0">
              <name>هياكل النور</name>
              <description>رحلة في رحاب النور</description>
              <author email="noreply@example.com" href="https://github.com/iqsd2020-ctrl">iqsd2020-ctrl</author>

              <content src="index.html" />
              <access origin="*" />
              <allow-navigation href="*" />
              <allow-intent href="http://*/*" />
              <allow-intent href="https://*/*" />
              <allow-intent href="tel:*" />
              <allow-intent href="sms:*" />
              <allow-intent href="mailto:*" />
              <allow-intent href="geo:*" />

              <preference name="ScrollEnabled" value="true" />
              <preference name="AndroidLaunchMode" value="singleTask" />
              <preference name="Orientation" value="portrait" />
              <preference name="Fullscreen" value="true" />
              <preference name="StatusBarOverlaysWebView" value="true" />
              <preference name="StatusBarBackgroundColor" value="#00000000" />
              <preference name="ResolveServiceWorkerRequests" value="true" />
              <preference name="AndroidWindowSplashScreenAnimatedIcon" value="www/Pic/512x512.png" />
              <preference name="SplashScreenDelay" value="0" />
              <preference name="ShowSplashScreenSpinner" value="false" />

              <icon src="www/Pic/512x512.png" />
          </widget>
          EOF

          rm -rf app/www
          mkdir -p app/www

          rsync -av --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "app" \
            --exclude "*.md" \
            ./ app/www/

          cd app
          cat > google-services.json <<'EOF'
          {
            "project_info": {
              "project_number": "160722124006",
              "firebase_url": "https://ahl-albayet-default-rtdb.firebaseio.com",
              "project_id": "ahl-albayet",
              "storage_bucket": "ahl-albayet.firebasestorage.app"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:160722124006:android:5fb834ef7797ba6bf80f27",
                  "android_client_info": {
                    "package_name": "com.iqsd2020.hyakl"
                  }
                },
                "oauth_client": [
                  {
                    "client_id": "160722124006-dllepep3cm6ltak4hk0c9760733iv182.apps.googleusercontent.com",
                    "client_type": 3
                  }
                ],
                "api_key": [
                  {
                    "current_key": "AIzaSyBx72L5nn17AjHNoriEvGZ8aSDOb0v2ZkI"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": [
                      {
                        "client_id": "160722124006-dllepep3cm6ltak4hk0c9760733iv182.apps.googleusercontent.com",
                        "client_type": 3
                      }
                    ]
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOF
          cordova plugin add cordova-plugin-statusbar
          cordova platform add android@14.0.1
          cordova plugin add cordova-plugin-firebasex

      - name: Build signed release APK
        working-directory: app
        run: >
          cordova build android --release -- --packageType=apk
          --keystore=../.secrets/hyakl-release.jks
          --storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          --alias=${{ secrets.ANDROID_KEY_ALIAS }}
          --password=${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: hyakl-release-apk
          path: |
            app/platforms/android/app/build/outputs/apk/release/*.apk
            app/platforms/android/app/build/outputs/apk/release/output-metadata.json
