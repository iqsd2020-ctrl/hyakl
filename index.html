<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>هياكل النور</title>    
    <link rel="dns-prefetch" href="https://firestore.googleapis.com">
    <link rel="stylesheet" href="fonts.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#064E3B">
    <script src="tailwind-lib.js"></script>      
    <link rel="stylesheet" href="style.css">
    <style>
        .glass-effect {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .liquid-loader {
            width: 220px;
            height: 10px;
            background: rgba(51, 65, 85, 0.85);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        .liquid-bar {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            border-radius: 20px;
            position: relative;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.65);
            transform-origin: left;
            animation: liquidProgress 2.2s ease-in-out infinite;
        }
        .liquid-bar::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: linear-gradient(
                -45deg,
                rgba(255, 255, 255, .22) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, .22) 50%,
                rgba(255, 255, 255, .22) 75%,
                transparent 75%,
                transparent
            );
            z-index: 1;
            background-size: 20px 20px;
            animation: moveLiquid 2s linear infinite;
        }
        @keyframes liquidProgress {
            0%   { transform: scaleX(0.12); opacity: .85; }
            50%  { transform: scaleX(0.92); opacity: 1; }
            100% { transform: scaleX(0.12); opacity: .85; }
        }
        @keyframes moveLiquid {
            0% { background-position: 0 0; }
            100% { background-position: 20px 20px; }
        }
        .fade-in { animation: fadeIn 0.6s ease-in-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
    </style>
</head>
<body class="flex flex-col items-center justify-center w-full h-full overflow-hidden bg-[#0f172a] fixed inset-0">
<div id="bottom-nav" class="hidden">
    <nav class="fixed bottom-0 left-0 w-full glass-effect z-50 pb-safe pointer-events-auto">
        <div class="flex justify-around items-center p-2 pointer-events-auto">
            <button id="menu-btn" type="button" class="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-200 transition-colors active:scale-[0.98]">
                <span class="material-symbols-rounded text-2xl">menu</span>
                <span class="text-[10px] font-heading">القائمة</span>
            </button>
            <button type="button" id="bottom-notifications-btn" class="relative flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-200 transition-colors active:scale-[0.98]" onclick="try{event&&event.stopPropagation&&event.stopPropagation();event&&event.preventDefault&&event.preventDefault();const b=document.getElementById('notif-btn');if(b){b.click()}else{const d=document.getElementById('notif-dropdown');if(d){d.classList.toggle('hidden');}}}catch(_){} return false;">
                <span class="material-symbols-rounded text-2xl">notifications</span>
                <span class="text-[10px] font-heading">الإشعارات</span>
                <span id="bottom-notif-badge" class="absolute -top-1 -left-1 w-3 h-3 rounded-full bg-red-600 hidden border-2 border-[#0f172a]"></span>
            </button>
            <button type="button" id="bottom-badges-btn" class="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-200 transition-colors active:scale-[0.98]" onclick="try{document.getElementById('nav-badges')?.click()}catch(_){}">
                <span class="material-symbols-rounded text-2xl">military_tech</span>
                <span class="text-[10px] font-heading">الأوسمة</span>
            </button>
            <button type="button" id="bottom-bag-btn" class="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-200 transition-colors active:scale-[0.98]" onclick="try{window.openBag&&window.openBag()}catch(_){}">
                <span class="material-symbols-rounded text-2xl">shopping_bag</span>
                <span class="text-[10px] font-heading">الحقيبة</span>
            </button>
            <button type="button" id="bottom-leaderboard-btn" class="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-200 transition-colors active:scale-[0.98]">
                <span class="material-symbols-rounded text-2xl">leaderboard</span>
                <span class="text-[10px] font-heading">الأوائل</span>
            </button>
        </div>
    </nav>
</div>
<div id="notif-dropdown" class="hidden fixed bottom-24 right-3 w-64 bg-slate-900 border border-amber-500/30 rounded-xl shadow-2xl overflow-hidden origin-top-left transition-all duration-200 z-[10040]">
    <div class="p-3 border-b border-slate-700 flex justify-between items-center bg-slate-800">
        <span class="text-amber-400 font-bold text-xs font-heading">الإشعارات</span>
        <button id="clear-notif-btn" class="text-[10px] text-red-400 hover:text-red-300">مسح الكل</button>
    </div>
    <div id="notif-list" class="max-h-64 overflow-y-auto bg-slate-900/95"></div>
</div>
<div id="side-menu-overlay"></div>
<div id="side-menu" class="side-menu flex flex-col h-full">
    <div class="side-menu-header p-6 text-center relative shrink-0">
        <div class="absolute inset-x-0 bottom-0 h-px bg-gradient-to-r from-transparent via-amber-500 to-transparent"></div>
        <h2 class="text-2xl font-bold text-amber-500 font-heading drop-shadow-md">القائمة</h2>
        <div class="flex justify-center mt-2">
            <span class="w-16 h-1 bg-amber-600 rounded-full"></span>
        </div>
    </div>
    <div class="side-menu-body flex-grow overflow-y-auto p-4 space-y-2 custom-scrollbar">
        <div class="menu-item" id="nav-achievements">
            <span class="material-symbols-rounded">draw</span> انجازاتي
        </div>
        <div class="menu-item" id="nav-badges">
            <span class="material-symbols-rounded">military_tech</span> الأوسمة
        </div>
        <div class="menu-item" id="nav-favs">
            <span class="material-symbols-rounded">favorite</span> المفضلة
        </div>
        <div class="menu-item" id="nav-mistakes">
            <span class="material-symbols-rounded">history_edu</span> الأخطاء السابقة
        </div>
        <div class="side-menu-separator my-4"></div>
        <div class="menu-item" id="nav-privacy">
            <span class="material-symbols-rounded">visibility_off</span> خيارات الخصوصية
        </div>
        <div class="menu-item" id="nav-settings">
            <span class="material-symbols-rounded">settings</span> الإعدادات
        </div>
        <div class="menu-item" id="nav-about">
            <span class="material-symbols-rounded">info</span> عن التطبيق
        </div>
        <div class="menu-item" id="nav-contact">
            <span class="material-symbols-rounded">mail</span> راسل المطور
        </div>
    </div>
    <div class="side-menu-footer p-4 mt-auto shrink-0">
        <button id="logout-btn-menu" class="w-full py-2 border border-red-500 text-red-400 rounded-lg hover:bg-red-500 hover:text-white transition font-bold flex justify-center items-center gap-2">
            <span class="material-symbols-rounded">logout</span> خروج
        </button>
    </div>
</div>
    <div id="main-container" class="w-full max-w-2xl h-full p-4 relative z-10 flex flex-col justify-center">
        <div id="auth-loading" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-[#0f172a] transition-opacity duration-700">
    <div class="mb-8 relative">
        <div class="w-28 h-28 rounded-full bg-slate-800 border-2 border-amber-400 flex items-center justify-center shadow-lg">
            <span class="material-symbols-rounded text-6xl text-amber-400">mosque</span>
        </div>
    </div>
    <h1 class="text-3xl font-bold text-white font-heading mb-2 tracking-wide drop-shadow-lg">
        هياكل النور
    </h1>
    <p class="text-amber-300/90 text-sm font-bold mb-8">
        جاري تجهيز المصادر...
    </p>
    <div class="liquid-loader">
        <div class="liquid-bar"></div>
    </div>
    <p class="mt-4 text-amber-400 font-heading text-xs opacity-80">
        رحلة في رحاب المعرفة...
    </p>
</div>
<div id="login-area" class="hidden fade-in">
            <div class="auth-shell">
                <div class="auth-ambient" aria-hidden="true">
                    <div class="auth-blob blob-1"></div>
                    <div class="auth-blob blob-2"></div>
                </div>
                <div class="auth-card">
                    <div class="auth-header">
                        <img src="Icon.png" class="auth-logo" alt="App Logo">
                        <h1 class="auth-title text-3xl">هياكل النور</h1>
                        <p class="auth-subtitle">مسابقات عقائدية وتاريخية</p>
                    </div>
                    <div class="auth-social-row">
                        <button id="google-login-btn" type="button" class="auth-btn-social">
                        <svg class="google-mark" viewBox="0 0 48 48" aria-hidden="true">
                            <path fill="#EA4335" d="M24 9.5c3.54 0 6.73 1.22 9.25 3.62l6.9-6.9C35.97 2.36 30.4 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.05 6.26C12.6 13.06 17.87 9.5 24 9.5z"/>
                            <path fill="#4285F4" d="M46.5 24.5c0-1.58-.14-3.1-.4-4.58H24v8.68h12.65c-.54 2.88-2.16 5.33-4.6 6.97l7.03 5.46C43.7 36.9 46.5 31.3 46.5 24.5z"/>
                            <path fill="#FBBC05" d="M10.61 28.48a14.5 14.5 0 0 1 0-8.96l-8.05-6.26a24 24 0 0 0 0 21.48l8.05-6.26z"/>
                            <path fill="#34A853" d="M24 48c6.4 0 11.77-2.12 15.69-5.77l-7.03-5.46c-1.95 1.31-4.44 2.08-8.66 2.08-6.13 0-11.4-3.56-13.39-8.72l-8.05 6.26C6.51 42.62 14.62 48 24 48z"/>
                        </svg>
                        <span> Google</span>
                    </button>
                        <button id="guest-login-btn" type="button" class="auth-btn-guest" aria-label="زائر">
                        <span class="material-symbols-rounded" aria-hidden="true">person</span>
                        <span>زائر</span>
                    </button>
                    </div>
                    <p class="auth-hint"></p>
                    <div class="auth-divider"><span></span></div>
                    <div id="auth-switcher" class="w-full mx-auto mb-5">
                        <div class="bg-slate-900/40 border border-white/10 rounded-2xl p-1 flex gap-1">
                            <button id="show-login-btn" type="button"
                                    class="flex-1 py-2.5 rounded-xl border font-bold font-heading text-sm transition duration-200 active:scale-95">
                                دخول
                            </button>
                            <button id="show-register-btn" type="button"
                                    class="flex-1 py-2.5 rounded-xl border font-bold font-heading text-sm transition duration-200 active:scale-95">
                                تسجيل
                            </button>
                        </div>
                    </div>
                    <div id="login-view">
                        <div class="auth-form space-y-4">
                            <div class="auth-field">
                                <span class="material-symbols-rounded auth-field-icon">mail</span>
                                <input dir="ltr" type="email" id="login-email-input" class="input-glass has-icon" placeholder="البريد الإلكتروني">
                            </div>
                            <div class="auth-field">
                                <span class="material-symbols-rounded auth-field-icon">lock</span>
                                <input type="password" id="login-password-input" class="input-glass has-icon" placeholder="كلمة المرور">
                            </div>
                            <p id="login-error-message" class="text-red-400 text-center text-sm min-h-[20px]"></p>
                            <div class="auth-actions">
                                <button id="email-login-btn" class="btn-gold-action text-fixed-white">دخول</button>
                            </div>
                        </div>
                    </div>
                    <div id="register-view" class="hidden">
                        <div class="auth-form space-y-4">
                            <div class="auth-field">
                                <span class="material-symbols-rounded auth-field-icon">badge</span>
                                <input type="text" id="reg-displayName-input" class="input-glass has-icon" placeholder="اسم داخل التطبيق (عربي)">
                            </div>
                            <div class="auth-field">
                                <span class="material-symbols-rounded auth-field-icon">mail</span>
                                <input dir="ltr" type="email" id="reg-email-input" class="input-glass has-icon" placeholder="البريد الإلكتروني">
                            </div>
                            <div class="auth-field">
                                <span class="material-symbols-rounded auth-field-icon">lock</span>
                                <input type="password" id="reg-password-input" class="input-glass has-icon" placeholder="كلمة المرور">
                            </div>
                            <div class="auth-field">
                                <span class="material-symbols-rounded auth-field-icon">verified_user</span>
                                <input type="password" id="reg-confirm-password-input" class="input-glass has-icon" placeholder="تأكيد كلمة المرور">
                            </div>
                            <p id="register-error-message" class="text-red-400 text-center text-sm min-h-[20px]"></p>
                            <div class="auth-actions">
                                <button id="email-register-btn" class="btn-gold-action bg-gradient-to-r from-green-600 to-green-500 text-fixed-white">تسجيل</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="welcome-area" class="hidden fade-in absolute inset-x-0 top-0 bottom-0 overflow-y-auto pb-0 px-6">                        
            <div class="flex flex-col min-h-full w-full pb-24 fade-in">
                <header class="flex justify-between items-center pt-6 pb-2">
                    <div class="w-10"></div>
                    <div class="flex items-center gap-2">
                        <button id="notif-btn" class="relative p-2 rounded-full bg-slate-800 border border-slate-700 text-slate-200 active:scale-95 transition hidden">
                            <span class="material-symbols-rounded">notifications</span>
                            <span id="notif-badge" class="absolute -top-1 -left-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-600 text-white text-[10px] font-bold hidden items-center justify-center border-2 border-[#0f172a]"></span>
                        </button>
                        <button id="user-profile-btn" class="w-10 h-10 rounded-full bg-slate-800 border border-amber-500/50 text-amber-300 flex items-center justify-center active:scale-95 transition hidden" title="حسابي">
                            <span class="material-symbols-rounded">person</span>
                        </button>
                    </div>
                </header>
                <div id="monasbat-banner" class="w-full mt-3 mb-4 rounded-3xl border border-emerald-500/25 bg-gradient-to-br from-emerald-900/30 via-slate-900/75 to-slate-900/55 backdrop-blur-md px-4 py-3 shadow-2xl shadow-black/50 relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 w-44 h-44 bg-emerald-400/10 rounded-full blur-3xl pointer-events-none"></div>
                    <div class="absolute -left-10 -bottom-10 w-44 h-44 bg-amber-400/10 rounded-full blur-3xl pointer-events-none"></div>
                    <div class="absolute right-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-amber-400/70 via-emerald-400/60 to-transparent"></div>
                    <div class="flex items-center justify-between gap-4 relative z-10">
                        <div class="flex items-center gap-3 min-w-0">
                            <div class="w-9 h-9 rounded-2xl bg-slate-950/35 border border-emerald-500/20 flex items-center justify-center shadow-lg shrink-0">
                                <span class="material-symbols-rounded text-xl text-amber-300">event</span>
                            </div>
                            <div class="min-w-0">
                                <div class="text-[11px] text-slate-400 font-bold">المناسبات</div>
                                <div id="monasbat-hijri-date" class="text-xs text-emerald-200 font-bold font-heading truncate">...</div>
                            </div>
                        </div>
                    </div>
                    <div id="monasbat-text" class="mt-3 text-sm text-slate-100 leading-7 whitespace-pre-line relative z-10">...</div>
                </div>
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-5 mb-4 border border-slate-700 shadow-lg relative overflow-hidden" onclick="try{document.getElementById('user-profile-btn')?.click()}catch(_){}">
                    <div class="absolute -left-10 -top-10 w-40 h-40 bg-amber-400 opacity-5 rounded-full blur-3xl pointer-events-none"></div>
                    <button id="guest-auth-btn-profile-card" type="button" class="hidden absolute top-4 left-4 w-10 h-10 rounded-full bg-slate-800 border border-amber-500/40 text-amber-300 flex items-center justify-center active:scale-95 transition animate-pulse" title="تسجيل الدخول / التسجيل" aria-label="تسجيل الدخول أو التسجيل" onclick="try{event.stopPropagation();}catch(_){} try{window.openGuestAuthRegister&&window.openGuestAuthRegister()}catch(_){}">
                            <svg class="google-mark" viewBox="0 0 48 48" aria-hidden="true">
                            <path fill="#EA4335" d="M24 9.5c3.54 0 6.73 1.22 9.25 3.62l6.9-6.9C35.97 2.36 30.4 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.05 6.26C12.6 13.06 17.87 9.5 24 9.5z"/>
                            <path fill="#4285F4" d="M46.5 24.5c0-1.58-.14-3.1-.4-4.58H24v8.68h12.65c-.54 2.88-2.16 5.33-4.6 6.97l7.03 5.46C43.7 36.9 46.5 31.3 46.5 24.5z"/>
                            <path fill="#FBBC05" d="M10.61 28.48a14.5 14.5 0 0 1 0-8.96l-8.05-6.26a24 24 0 0 0 0 21.48l8.05-6.26z"/>
                            <path fill="#34A853" d="M24 48c6.4 0 11.77-2.12 15.69-5.77l-7.03-5.46c-1.95 1.31-4.44 2.08-8.66 2.08-6.13 0-11.4-3.56-13.39-8.72l-8.05 6.26C6.51 42.62 14.62 48 24 48z"/>
                        </svg>
                    </button>
                    <div class="flex items-center gap-4 relative z-10">
                        <div id="profile-card-avatar" class="avatar-wrapper w-16 h-16 rounded-full bg-slate-700 border-2 border-amber-400">
                            <div class="w-full h-full rounded-full overflow-hidden flex items-center justify-center">
                                <img id="profile-card-avatar-img" src="Icon.png" alt="Logo" class="w-full h-full object-contain p-2" referrerpolicy="no-referrer">
                                <div id="profile-card-avatar-text" class="hidden w-full h-full flex items-center justify-center text-center px-1">
                                    <span class="text-[10px] leading-tight text-slate-200 font-bold">ضع صورتك هنا</span>
                                </div>
                            </div>
                            <div id="profile-card-avatar-frame" class="avatar-frame-overlay frame-default"></div>
                        </div>
                        <div class="flex-1">
                            <h2 id="username-display" class="text-xl font-heading text-white">زائر</h2>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="material-symbols-rounded text-amber-400 text-lg">monetization_on</span>
                                <span id="header-score" class="text-amber-300 font-bold text-lg font-heading">0</span>
                                <span class="text-xs text-slate-400 mr-1">نقطة</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 bg-slate-950/40 rounded-lg p-3 border border-white/5">
                        <div class="flex items-center justify-between">
                            <div class="text-xs text-slate-400">نظام التقدم والمستويات</div>
                        </div>
                        <div class="mt-3 flex items-center gap-3">
                            <div class="flex-1">
                                <div class="glass-tube-container h-10 w-full border border-amber-500/20">
                                    <div id="player-level-progress-fill" class="liquid-fill liquid-gold"></div>
                                    <div class="player-level-tube-text absolute inset-0 flex items-center justify-center z-[3] pointer-events-none text-[11px] sm:text-xs font-bold text-slate-100">
                                        <span id="player-level-progress-text">%٠ • المتبقي: ٥٠</span>
                                    </div>
                                </div>
                            </div>
                            <div class="shrink-0 bg-slate-900/50 border border-amber-500/25 rounded-xl px-3 py-2 text-center">
                                <div class="text-[10px] text-slate-400 mb-1">المستوى</div>
                                <div id="player-level-number" class="text-amber-300 font-bold text-xl font-heading leading-none">١</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-3 mb-6">
                    <div class="relative">
                        <button id="btn-category-trigger" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 flex justify-between items-center active:scale-[0.99] transition-transform">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-emerald-900/30 flex items-center justify-center text-emerald-300">
                                    <span class="material-symbols-rounded">category</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-slate-400">القسم</div>
                                    <div id="txt-category-display" class="text-white font-heading text-lg">تصفح المكتبة</div>
                                </div>
                            </div>
                            <span class="material-symbols-rounded text-slate-500">expand_more</span>
                        </button>
                        <input type="hidden" id="category-select" value="">
                    </div>
                    <div class="relative">
                        <button id="btn-topic-trigger" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 flex justify-between items-center active:scale-[0.99] transition-transform" disabled>
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-900/30 flex items-center justify-center text-blue-300">
                                    <span class="material-symbols-rounded">menu_book</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-slate-400">الموضوع</div>
                                    <div id="txt-topic-display" class="text-white font-heading text-lg">اختر الموضوع</div>
                                </div>
                            </div>
                            <span class="material-symbols-rounded text-slate-500">expand_more</span>
                        </button>
                        <input type="hidden" id="topic-select" value="">
                    </div>
                    <div class="relative">
                        <button id="btn-count-trigger" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 flex justify-between items-center active:scale-[0.99] transition-transform">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-purple-900/30 flex items-center justify-center text-purple-300">
                                    <span class="material-symbols-rounded">format_list_numbered</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-slate-400">عدد الأسئلة</div>
                                    <div id="txt-count-display" class="text-white font-heading text-lg">١٠ أسئلة</div>
                                </div>
                            </div>
                            <span class="material-symbols-rounded text-slate-500">expand_more</span>
                        </button>
                        <input type="hidden" id="ai-question-count" value="10">
                    </div>
                </div>
                <button id="ai-generate-btn" class="w-full bg-gradient-to-r from-amber-400 to-amber-600 rounded-xl p-4 shadow-lg active:scale-[0.99] transition-all relative overflow-hidden group mb-4 btn-gold-action">
                    <div class="absolute inset-0 bg-white/15 group-hover:bg-white/25 transition-colors"></div>
                    <div class="relative z-10 flex items-center justify-center gap-2">
                        <span class="material-symbols-rounded text-[#0f172a] text-3xl">play_circle</span>
                        <span class="text-[#0f172a] font-heading font-bold text-2xl">ابدأ التحدي</span>
                    </div>
                </button>
                <button id="review-mistakes-btn" class="hidden w-full bg-slate-800 border border-red-900/50 rounded-xl p-3 flex justify-center items-center gap-2 mb-4 active:scale-[0.99] transition">
                    <span class="material-symbols-rounded text-red-400">history_edu</span>
                    <span id="review-mistakes-text" class="text-red-100 font-amiri">مراجعة أخطائي</span>
                </button>
                <div id="daily-quest-container" class="quest-container w-full flex justify-center hidden mt-1 mb-5">
                    <button id="btn-open-quests" class="group relative w-full overflow-hidden rounded-2xl p-[1px] transition-all hover:scale-[1.01] active:scale-95 shadow-lg">
                        <div class="absolute inset-0 bg-gradient-to-r from-amber-500/20 via-slate-600 to-amber-500/20 opacity-50 group-hover:opacity-100 transition-opacity"></div>
                        <div class="relative flex items-center justify-between rounded-2xl bg-slate-900/90 backdrop-blur-md p-3 border border-white/5">
                            <div class="flex items-center gap-4">
                                <div class="relative flex h-11 w-11 items-center justify-center rounded-xl bg-gradient-to-br from-amber-900/40 to-slate-800 border border-amber-500/30 shadow-[0_0_15px_rgba(245,158,11,0.15)] group-hover:shadow-[0_0_20px_rgba(245,158,11,0.3)] transition-shadow">
                                    <span class="material-symbols-rounded text-2xl text-amber-400 group-hover:scale-110 transition-transform">military_tech</span>
                                </div>
                                <div class="text-right z-10">
                                    <h4 class="font-heading text-sm font-bold text-white group-hover:text-amber-400 transition-colors tracking-wide">المهام اليومية</h4>
                                    <p class="text-[10px] text-slate-400 font-medium">جوائز وتحديات جديدة</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 pl-1">
                                <span id="quest-notification-badge" class="hidden bg-red-600 text-white text-[10px] font-bold px-1.5 min-w-[18px] h-[18px] rounded-full flex items-center justify-center border border-slate-900 shadow-sm z-10">!</span>
                                <div class="h-8 w-8 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700 group-hover:bg-amber-500 group-hover:border-amber-400 group-hover:text-slate-900 transition-all duration-300">
                                    <span class="material-symbols-rounded text-lg text-slate-400 group-hover:text-slate-900 rotate-180 group-hover:-translate-x-0.5 transition-transform">arrow_right_alt</span>
                                </div>
                            </div>
                        </div>
                    </button>
                </div>
                <div class="bg-gradient-to-r from-indigo-900/50 to-purple-900/50 rounded-xl p-4 border border-indigo-500/30 relative overflow-hidden mb-2">
                    <div class="flex justify-between items-center relative z-10">
                        <div>
                            <h3 class="font-heading text-white text-lg">أكمل النور</h3>
                            <p class="text-slate-300 text-xs mt-1">التحدي اليومي</p>
                        </div>
                        <button id="btn-marathon-start" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-heading text-sm active:scale-95 transition">
                            دخول
                        </button>
                    </div>
                </div>
                <div id="tf-card" class="bg-gradient-to-r from-slate-900/50 to-slate-800/50 rounded-xl p-4 border border-amber-500/20 relative overflow-hidden mb-2">
                    <div class="flex justify-between items-center relative z-10">
                        <div>
                            <h3 class="font-heading text-white text-lg">صح أو خطأ</h3>
                            <p class="text-slate-300 text-xs mt-1">تحدي سريع</p>
                        </div>
                        <button id="btn-tf-start" class="bg-amber-600 hover:bg-amber-500 text-slate-900 px-4 py-2 rounded-lg font-heading text-sm active:scale-95 transition">
                            ابدأ
                        </button>
                    </div>
                    <div class="relative z-10 mt-3">
                        <div class="flex items-center gap-3">
                            <div class="flex-1 h-2 rounded-full bg-slate-900/60 border border-amber-500/20 overflow-hidden shadow shadow-black/20">
                                <div id="tf-home-progress" class="h-full w-0 bg-gradient-to-l from-amber-400/90 to-amber-600/70 transition-all duration-300"></div>
                            </div>
                            <span id="tf-home-progress-text" class="text-[10px] text-slate-200 font-bold font-heading min-w-[64px] text-left">0/0</span>
                        </div>
                        <div class="mt-2 flex items-center justify-between text-[10px]">
                            <span id="tf-home-remaining" class="text-amber-400/90 font-bold hidden">متبقي 0</span>
                            <span id="tf-home-badge" class="hidden px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/20 font-bold">مكتمل</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="truefalse-view" class="hidden w-full h-full flex flex-col fade-in relative">
            <div class="flex justify-between items-center py-4 border-b border-amber-500/20 mb-4 px-4">
                <button id="btn-back-truefalse" class="text-slate-400 hover:text-white transition transform hover:-translate-x-1">
                    <span class="material-symbols-rounded text-2xl">arrow_forward</span>
                </button>
                <div class="text-center">
                    <h2 class="text-xl font-bold text-white font-heading">صح أو خطأ</h2>
                    <p class="text-[10px] text-amber-500/80 font-bold">سلسلة عشوائية</p>
                </div>
                <div class="w-6"></div>
            </div>
            <div class="flex-1 overflow-y-auto px-4 pb-24">
                <div class="mx-auto max-w-[520px] space-y-4">
                    <div class="relative h-5 rounded-full bg-slate-900/60 border border-amber-500/25 overflow-hidden shadow shadow-black/30">
                        <div id="tf-progress-fill" class="absolute inset-y-0 right-0 w-0 bg-gradient-to-l from-amber-400/90 to-amber-600/70 transition-all duration-300"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="tf-progress-text" class="text-[11px] font-bold text-white font-heading drop-shadow">0/0</span>
                        </div>
                    </div>
                    <div class="bg-slate-900/55 backdrop-blur-md rounded-2xl border border-amber-500/20 p-5 shadow-lg shadow-black/30">
                        <p id="tf-question" class="text-white text-2xl leading-relaxed font-bold">جاري تحميل الأسئلة...</p>
                        <p id="tf-status" class="text-[10px] text-amber-400 mt-2 hidden"></p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="tf-btn-true" class="bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-2xl font-heading text-sm border border-white/10 shadow-lg shadow-black/30 active:scale-95 transition">صح</button>
                        <button id="tf-btn-false" class="bg-rose-600 hover:bg-rose-500 text-white py-3 rounded-2xl font-heading text-sm border border-white/10 shadow-lg shadow-black/30 active:scale-95 transition">خطأ</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="leaderboard-view" class="hidden w-full h-full flex flex-col fade-in relative">
            <div class="flex justify-between items-center py-4 border-b border-amber-500/20 mb-4 px-4">
                <button id="btn-back-leaderboard" class="text-slate-400 hover:text-white transition transform hover:-translate-x-1">
                    <span class="material-symbols-rounded text-2xl">arrow_forward</span>
                </button>
                <div class="text-center">
                    <h2 class="text-xl font-bold text-white font-heading">لوحة الشرف</h2>
                    <p class="text-[10px] text-amber-500/80 font-bold">أبطال هذا الشهر</p>
                </div>
                <div class="w-6"></div>
            </div>
            <div id="leaderboard-content" class="flex-1 overflow-y-auto px-4 pb-24">
                <button id="guest-auth-btn-leaderboard" type="button" class="hidden w-full mb-5 py-3 rounded-2xl bg-white text-slate-900 font-bold flex items-center justify-center gap-3 border border-white/10 shadow-lg shadow-black/20 active:scale-95 transition" title="تسجيل الدخول / التسجيل" aria-label="تسجيل الدخول أو التسجيل" onclick="try{window.openGuestAuth&&window.openGuestAuth()}catch(_){}">
    <span class="w-6 h-6 flex items-center justify-center" aria-hidden="true">
        <svg width="22" height="22" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <path fill="#EA4335" d="M24 9.5c3.54 0 6.73 1.22 9.25 3.62l6.87-6.87C35.92 2.38 30.28 0 24 0 14.64 0 6.49 5.38 2.56 13.22l8.03 6.23C12.45 13.02 17.76 9.5 24 9.5z"/>
            <path fill="#4285F4" d="M46.15 24.55c0-1.57-.14-3.08-.4-4.55H24v9.08h12.45c-.54 2.9-2.18 5.36-4.66 7.02l7.52 5.84c4.4-4.06 6.84-10.04 6.84-17.39z"/>
            <path fill="#FBBC05" d="M10.59 28.45c-.5-1.48-.79-3.06-.79-4.7s.29-3.22.79-4.7l-8.03-6.23C.92 16.24 0 20.02 0 23.75s.92 7.51 2.56 10.93l8.03-6.23z"/>
            <path fill="#34A853" d="M24 48c6.28 0 11.55-2.08 15.4-5.66l-7.52-5.84c-2.08 1.4-4.75 2.23-7.88 2.23-6.24 0-11.55-3.52-13.41-8.95l-8.03 6.23C6.49 42.62 14.64 48 24 48z"/>
        </svg>
    </span>
    <span class="font-heading">تسجيل الدخول / التسجيل</span>
</button>
                <div id="leaderboard-reset-timer" class="hidden mb-6 p-4 bg-amber-500/10 border border-amber-500/30 rounded-2xl text-center animate-fade-in">
                    <p class="text-[10px] font-bold text-amber-500 uppercase tracking-widest mb-2">سيتم تصفير لوحة المتصدرين بعد</p>
                    <div id="reset-timer-display" class="text-2xl font-bold text-white font-mono tracking-widest">0:00:00:00</div>
                </div>
                <div id="leaderboard-loading" class="text-center py-10">
                    <div id="leaderboard-progress-label" class="text-amber-400 font-black text-lg font-mono mb-2">0%</div>
                    <div class="w-full max-w-sm mx-auto h-3 bg-amber-500/10 border border-amber-500/20 rounded-full overflow-hidden">
                        <div id="leaderboard-progress-bar" class="h-full bg-amber-500 rounded-full transition-all duration-200" style="width:0%"></div>
                    </div>
                    <p id="leaderboard-loading-text" class="text-amber-500 text-sm font-bold animate-pulse mt-3">يتم عرض المتصدرين ....</p>
                </div>
                <div id="leaderboard-list" class="space-y-3 hidden"></div>
                <div class="mt-8 p-4 bg-slate-900/50 rounded-2xl border border-white/5 text-center">
                    <p class="text-[10px] text-slate-500">يتم تصفير لوحة المتصدرين تلقائياً في بداية كل شهر ميلادي</p>
                </div>
            </div>
        </div>
        <div id="achievements-view" class="hidden w-full h-full flex flex-col fade-in relative">
            <div class="flex justify-between items-center py-4 border-b border-amber-500/20 mb-4 px-4">
                <button id="btn-back-achievements" class="text-slate-400 hover:text-white transition transform hover:-translate-x-1">
                    <span class="material-symbols-rounded text-2xl">arrow_forward</span>
                </button>
                <div class="text-center">
                    <h2 class="text-xl font-bold text-white font-heading">إنجازاتي</h2>
                    <p class="text-[10px] text-amber-500/80 font-bold">معرض التقدّم والجوائز</p>
                </div>
                <div class="w-6"></div>
            </div>
            <div class="flex-1 overflow-y-auto px-2 pb-24">
                <div class="mx-auto max-w-[520px]">
                    <div class="mb-4 mx-3 p-4 rounded-2xl bg-slate-900/50 border border-white/5 text-slate-300 text-[11px] leading-relaxed">
                        كل بطاقة تُظهر نسبة تقدمك. عند إكمال إنجاز، يظهر زر تحميل الصورة عالية الدقة.
                    </div>
                </div>
                <div id="achievements-grid" class="achievements-grid"></div>
            </div>
        </div>
<div id="quiz-proper" class="hidden w-full h-full flex flex-col justify-center py-2 relative">
    <div id="quiz-topic-display" class="text-center text-amber-300/90 text-sm font-heading mb-2 tracking-wide bg-white/5 py-1 rounded-lg mx-auto w-fit px-4 border border-white/5"></div>
    <div class="flex justify-between items-center text-sm text-slate-400 font-heading mb-2">
        <div class="flex items-center gap-2">
            <button id="quit-quiz-btn" class="text-slate-500 hover:text-red-400 transition p-1" title="خروج"><span class="material-symbols-rounded">close</span></button>
            <button id="toggle-enrichment-btn" class="hover:text-white transition p-1" title="إيقاف/تشغيل المعلومات الإثرائية">
  <span id="enrichment-candle-icon" class="material-symbols-rounded">candle</span>
</button>
<button id="mute-audio-btn" class="text-slate-500 hover:text-white transition p-1" title="كتم الصوت">
    <span class="material-symbols-rounded">volume_up</span>
</button>
<span id="question-counter-text" class="bg-slate-800 px-2 py-1 rounded-lg text-xs">1/10</span>        </div>
        <div class="flex items-center gap-1">
            <span id="streak-icon" class="material-symbols-rounded text-orange-500 streak-fire text-2xl">local_fire_department</span>
            <span id="streak-count" class="text-orange-400 font-bold text-lg opacity-0 transition">x0</span>
            <div id="lives-display" class="flex items-center gap-1 mx-2"></div>
        </div>
        <span id="live-score-text" class="text-amber-400 font-bold text-lg transition-all">0</span>
    </div>
    <div class="flex justify-center mb-4"><div id="progress-dots" class="w-full max-w-xl mx-auto"></div></div>
    <div class="flex items-center justify-center text-center mb-6 p-6 relative shrink-0 min-h-[160px] w-full max-w-xl mx-auto transition-all duration-300 question-card-modern">
    <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md rounded-2xl border border-white/5 shadow-2xl question-surface-modern"></div>
    <div class="absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-amber-500/60 rounded-tr-xl"></div>
    <div class="absolute top-0 left-0 w-8 h-8 border-t-2 border-l-2 border-amber-500/60 rounded-tl-xl"></div>
    <div class="absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-amber-500/60 rounded-br-xl"></div>
    <div class="absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-amber-500/60 rounded-bl-xl"></div>
    <div class="absolute top-0 inset-x-0 h-px bg-gradient-to-r from-transparent via-amber-500/30 to-transparent"></div>
    <h2 id="question-text" class="relative z-10 text-xl md:text-2xl font-bold text-white leading-loose font-heading drop-shadow-md px-2">
        جاري جلب السؤال...
    </h2>
</div>
    <div id="options-container" class="space-y-1 mb-4 flex-1 flex flex-col justify-center"></div>
    <div class="flex justify-center gap-4 border-t border-slate-700 pt-4" id="helper-bar">
        <button id="helper-fifty-fifty" class="text-slate-500 hover:text-amber-400 text-xs flex flex-col items-center transition group"><span class="material-symbols-rounded bg-slate-800 p-2 rounded-full border border-slate-600 mb-1 group-hover:border-amber-400 transition">percent</span>حذف خيارين</button>
        <button id="helper-hint" class="text-slate-500 hover:text-amber-400 text-xs flex flex-col items-center transition group"><span class="material-symbols-rounded bg-slate-800 p-2 rounded-full border border-slate-600 mb-1 group-hover:border-amber-400 transition">lightbulb</span>حذف خيار</button>
        <button id="helper-skip" class="text-slate-500 hover:text-amber-400 text-xs flex flex-col items-center transition group"><span class="material-symbols-rounded bg-slate-800 p-2 rounded-full border border-slate-600 mb-1 group-hover:border-amber-400 transition">skip_next</span>تخطي السؤال</button>
        <button id="action-fav" class="text-slate-500 hover:text-red-400 text-xs flex flex-col items-center transition group"><span class="material-symbols-rounded bg-slate-800 p-2 rounded-full border border-slate-600 mb-1 group-hover:border-red-400 transition">favorite_border</span>حفظ السؤال</button>
        <button id="helper-report" class="text-slate-500 hover:text-red-400 text-xs flex flex-col items-center transition group"><span class="material-symbols-rounded bg-slate-800 p-2 rounded-full border border-slate-600 mb-1 group-hover:border-red-400 transition">flag</span>إبلاغ</button>
    </div>
    <p id="feedback-text" class="text-center mt-2 font-bold h-6"></p>
</div>
        <div id="results-area" class="hidden text-center fade-in">
            <h2 class="text-3xl font-bold text-white mb-6 font-heading">النتيجة النهائية</h2>
                        <div id="score-card" class="bg-slate-800 p-6 rounded-2xl border border-amber-500/30 mb-6 relative overflow-hidden shadow-2xl transform hover:scale-[1.01] transition duration-500">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-600 via-yellow-400 to-amber-600"></div>
                <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-amber-500/10 rounded-full blur-2xl"></div>
                <div class="flex justify-between border-b border-slate-700 pb-2 mb-4">
                    <div class="text-right">
                        <p class="text-slate-400 text-xs">اللاعب</p>
                        <p id="card-username" class="text-lg font-bold text-fixed-white font-heading">...</p>
                    </div>
                    <div class="text-left">
                        <p class="text-slate-400 text-xs">المستوى</p>
                        <p id="card-difficulty" class="text-fixed-white font-mono text-xs">موحد</p>
                    </div>
                </div>
                <div class="py-4">
                    <span id="card-score" class="text-6xl font-bold text-fixed-white font-heading block mb-2 drop-shadow-lg">0</span>
                    <span class="text-amber-400 text-sm font-heading uppercase tracking-widest">نقطة مكتسبة</span>
                </div>
                <div class="flex justify-center gap-4 mt-2 text-xs text-slate-400">
                    <span id="card-correct-count" class="flex items-center gap-1"><span class="material-symbols-rounded text-green-400 text-sm">check_circle</span> 0</span>
                    <span id="card-wrong-count" class="flex items-center gap-1"><span class="material-symbols-rounded text-red-400 text-sm">cancel</span> 0</span>
                </div>
                <p id="final-message" class="text-lg text-slate-300 mt-4 font-bold"></p>
                <div id="share-footer" class="hidden mt-4 pt-2 border-t border-slate-700 text-[10px] text-slate-500 flex justify-between"><span> تطبيق: هياكل النور</span></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button id="share-text-button" class="btn-secondary bg-slate-700 text-white py-3 rounded-xl justify-center border border-slate-600 hover:bg-slate-600 hover:border-amber-400 transition">مشاركة النتيجة</button>
                <button id="restart-button" class="btn-gold-action">الرئيسية</button>
            </div>
            <div id="review-area" class="hidden text-right mt-6 p-4 bg-slate-800/50 rounded-xl border border-slate-700">
                 <h3 class="text-amber-400 font-bold mb-3">مراجعة الأخطاء</h3>
                 <div id="review-items-container" class="max-h-60 overflow-y-auto space-y-3 scrollbar-thin"></div>
            </div>
        </div>
    </div>
  <div id="enrichment-modal" class="modal-overlay hidden z-50 fixed inset-0 flex items-center justify-center bg-black/90 transition-opacity duration-300">
    <div class="holo-card">
        <div class="holo-lamp-icon">
            <span class="material-symbols-rounded text-2xl">lightbulb</span>
        </div>
        <h3 class="holo-title">إضاءة معرفية</h3>
        <div class="relative overflow-hidden">
            <p id="enrichment-content" class="holo-text">
                </p>
        </div>
        <div class="text-[10px] text-cyan-500/50 mt-4 font-mono tracking-widest border-t border-cyan-500/10 pt-2">
            اضغط للمتابعة
        </div>
    </div>
</div>
    <div id="badges-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="flex justify-between mb-4">
                <h3 class="text-xl font-bold text-amber-400 font-heading">مكتبة الأوسمة</h3>
                <button class="close-modal text-slate-400 hover:text-white">✕</button>
            </div>
            <div id="badges-list" class="badges-grid"></div>
      </div>
         </div>
<div id="news-modal" class="modal-overlay z-[70] backdrop-blur-sm">
  <div class="modal-box w-[95vw] max-w-2xl relative overflow-hidden bg-slate-900 rounded-3xl border border-amber-500/30 shadow-[0_0_40px_rgba(245,158,11,0.15)] transform transition-all max-h-[92vh] flex flex-col">
    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-500 to-transparent shadow-[0_0_15px_#f59e0b]"></div>
    <div class="absolute inset-0 opacity-10 pointer-events-none bg-news-radial"></div>
    <div class="relative z-10 px-4 pt-5 pb-4 text-center flex flex-col h-full">
      <div class="mb-3">
        <div class="relative inline-block">
          <div class="absolute inset-0 bg-amber-500 blur-xl opacity-15 animate-pulse"></div>
          <div class="relative bg-gradient-to-b from-slate-800 to-slate-950 border border-amber-500/35 w-16 h-16 rounded-2xl flex items-center justify-center shadow-xl mx-auto transition-transform duration-300">
            <img src="Icon.png"
                 alt="App Icon"
                 class="w-10 h-10 object-contain drop-shadow-[0_0_12px_rgba(245,158,11,0.35)]">
          </div>
          <span class="absolute -top-2 -right-2 bg-red-600 text-white text-[9px] font-bold px-2 py-0.5 rounded-full border border-slate-900 shadow-md animate-pulse z-20">
            جديد
          </span>
        </div>
        <h3 class="text-lg font-bold text-white font-heading mt-2 tracking-wide">
          أخبار التطبيق
        </h3>
        <p class="text-amber-500/70 text-[11px] font-bold mt-1">
          رسالة المطور
        </p>
      </div>
      <div class="bg-slate-950/60 p-5 rounded-2xl border border-white/5 text-right relative flex-1 min-h-[300px] overflow-hidden flex flex-col">
        <div class="absolute right-0 top-4 bottom-4 w-1 bg-gradient-to-b from-amber-600 to-amber-400 rounded-l-full shadow-[0_0_10px_#f59e0b]"></div>
        <div id="news-content"
             class="text-slate-200 text-base leading-8 font-medium whitespace-pre-line overflow-y-auto pl-2 pr-5 flex-1 scrollbar-thin scrollbar-thumb-amber-900 scrollbar-track-transparent">
        </div>
      </div>
      <button id="close-news-btn"
              class="mt-4 w-full py-3 rounded-xl bg-gradient-to-r from-amber-600 via-yellow-500 to-amber-600 text-slate-900 font-bold shadow-lg hover:shadow-amber-500/20 hover:scale-[1.02] active:scale-95 transition-all duration-200 flex items-center justify-center gap-2 border-t border-white/20">
        <span class="material-symbols-rounded text-xl">verified</span>
        <span>دخول</span>
      </button>
    </div>
  </div>
</div>
    <div id="player-profile-modal" class="modal-overlay">
        <div class="modal-box border border-amber-500/30">
            <button type="button" class="close-modal absolute top-4 left-4 text-slate-400 hover:text-white z-50 p-2 text-xl font-bold transition hover:scale-110">✕</button>
            <div class="text-center mb-6 relative">
                 <div class="w-24 h-24 rounded-full mx-auto border-4 border-amber-500 shadow-lg overflow-hidden relative bg-slate-800 flex items-center justify-center">
                     <img id="popup-player-img" src="" class="w-full h-full object-cover hidden" alt="">
                     <span id="popup-player-icon" class="material-symbols-rounded text-6xl text-slate-500">account_circle</span>
                 </div>
                 <h3 id="popup-player-name" class="text-2xl font-bold text-white mt-4 font-heading">...</h3>
                 <div class="mt-4 flex items-center gap-3 justify-center">
                     <div class="flex-1 max-w-[240px]">
                         <div class="glass-tube-container h-10 w-full border border-amber-500/20">
                             <div id="popup-player-level-progress-fill" class="liquid-fill liquid-gold"></div>
                             <div class="player-level-tube-text absolute inset-0 flex items-center justify-center z-[3] pointer-events-none text-[11px] sm:text-xs font-bold text-slate-100">
                                 <span id="popup-player-level-progress-text">%٠ • المتبقي: ٥٠</span>
                             </div>
                         </div>
                     </div>
                     <div class="shrink-0 bg-slate-900/50 border border-amber-500/25 rounded-xl px-3 py-2 text-center">
                         <div class="text-[10px] text-slate-400 mb-1">المستوى</div>
                         <div id="popup-player-level-number" class="text-amber-300 font-bold text-xl font-heading leading-none">١</div>
                     </div>
                 </div>
            </div>
            <!-- زر تحدي صديق -->
            <div id="challenge-btn-container" class="mb-4 hidden">
                <button id="btn-challenge-friend" class="w-full py-3 rounded-xl bg-gradient-to-r from-orange-600 to-amber-500 text-white font-bold shadow-lg hover:shadow-orange-500/20 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                    <span class="material-symbols-rounded">swords</span>
                    <span>تحدي صديق</span>
                </button>
            </div>
            <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                <h4 class="text-sm text-slate-400 mb-3 border-b border-slate-700 pb-2">الأوسمة المكتسبة</h4>
                <div id="popup-player-badges" class="flex flex-wrap gap-2 justify-center min-h-[50px]"></div>
            </div>
        </div>
    </div>
    <div id="fav-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="flex justify-between mb-4">
                <h3 class="text-xl font-bold text-red-400 font-heading">المفضلة</h3>
                <button class="close-modal text-slate-400 hover:text-white">✕</button>
            </div>
            <div id="fav-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-1"></div>
        </div>
    </div>
    <div id="fav-detail-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-amber-400 font-heading">تفاصيل المفضلة</h3>
                <button id="fav-detail-close" class="text-slate-400 hover:text-white">✕</button>
            </div>
            <div class="space-y-4">
                <div class="p-3 bg-slate-800/50 rounded-xl border border-slate-700">
                    <p class="text-[11px] text-slate-400 mb-1 font-bold">السؤال</p>
                    <p id="fav-detail-question" class="text-slate-100 text-sm leading-relaxed whitespace-pre-wrap"></p>
                </div>
                <div class="p-3 bg-slate-800/50 rounded-xl border border-slate-700">
                    <p class="text-[11px] text-slate-400 mb-1 font-bold">الإجابة</p>
                    <p id="fav-detail-answer" class="text-emerald-300 text-sm font-bold leading-relaxed whitespace-pre-wrap"></p>
                </div>
                <div class="p-3 bg-slate-800/50 rounded-xl border border-slate-700">
                    <p class="text-[11px] text-slate-400 mb-1 font-bold">المعلومة الإثرائية</p>
                    <p id="fav-detail-enrichment" class="text-amber-200/90 text-sm leading-relaxed whitespace-pre-wrap"></p>
                </div>
            </div>
        </div>
    </div>
    <div id="settings-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300" dir="rtl">
        <div class="w-full max-w-lg mx-4 bg-[#0f172a] rounded-3xl border border-white/10 shadow-2xl shadow-indigo-500/20 overflow-hidden flex flex-col max-h-[90dvh]">
            <div class="shrink-0 px-5 sm:px-6 py-4 border-b border-white/10 bg-slate-900/40 relative">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-3/4 h-1 bg-gradient-to-r from-transparent via-indigo-500 to-transparent opacity-70 blur-sm"></div>
                <div class="flex items-center justify-between gap-3">
                    <div class="min-w-0">
                        <h3 class="text-xl sm:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-300 via-white to-cyan-300 font-heading truncate">
                            ⚙️ الإعـدادات
                        </h3>
                        <p class="text-slate-400 text-[11px] sm:text-xs mt-1 font-medium tracking-wide">تخصيص تجربة الاستخدام الخاصة بك</p>
                    </div>
                    <button class="close-modal shrink-0 text-slate-400 hover:text-white hover:bg-white/10 rounded-full p-2 transition-all" aria-label="إغلاق">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar px-5 sm:px-6 py-5 space-y-5">
                <section class="bg-white/5 border border-white/5 rounded-2xl p-4 sm:p-5 hover:bg-white/10 hover:border-indigo-500/30 transition-all duration-300">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex items-center gap-3 min-w-0">
                            <div class="w-10 h-10 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-300">
                                <span class="material-symbols-rounded text-xl">volume_up</span>
                            </div>
                            <div class="min-w-0">
                                <div class="flex items-center gap-2">
                                    <p class="text-slate-200 font-semibold text-sm">المؤثرات الصوتية</p>
                                    <span id="sound-status-label" class="text-[10px] px-2 py-0.5 rounded-full bg-slate-900/40 border border-white/10 text-slate-300">مفعل</span>
                                </div>
                                <p class="text-slate-500 text-[11px]">تشغيل/إيقاف أصوات اللعبة والتنبيهات</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="mute-toggle" class="sr-only peer" checked>
                            <div class="w-12 h-6 bg-slate-700 rounded-full peer
                                peer-checked:bg-gradient-to-r peer-checked:from-indigo-500 peer-checked:to-cyan-500
                                after:content-[''] after:absolute after:top-[2px] after:right-[2px]
                                after:bg-white after:rounded-full after:h-5 after:w-5 after:shadow-sm
                                after:transition-all peer-checked:after:-translate-x-full"></div>
                        </label>
                    </div>
                    <div class="mt-4 pt-4 border-t border-white/10">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-rounded text-pink-300">music_note</span>
                                <p class="text-slate-200 font-semibold text-sm">مستوى الصوت</p>
                            </div>
                            <span class="bg-slate-800 px-2 py-0.5 rounded text-pink-300 text-xs font-mono border border-slate-700">
                                <span id="sfx-volume-number">30</span>%
                            </span>
                        </div>
                        <input
                            type="range"
                            id="bg-music-volume"
                            min="0"
                            max="100"
                            value="30"
                            class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-pink-500 hover:accent-pink-400 transition-all">
                        <div class="mt-3 flex items-center justify-between gap-2">
                            <button id="test-sfx-btn" class="flex-1 bg-slate-900/40 hover:bg-slate-900/60 border border-white/10 text-slate-200 rounded-xl py-2.5 text-xs font-bold transition active:scale-95 flex items-center justify-center gap-2">
                                <span class="material-symbols-rounded text-base">graphic_eq</span>
                                اختبار الصوت
                            </button>
                            <button id="reset-settings-btn" class="shrink-0 bg-white/5 hover:bg-white/10 border border-white/10 text-slate-300 rounded-xl py-2.5 px-3 text-xs font-bold transition active:scale-95 flex items-center justify-center gap-2" title="إعادة الضبط">
                                <span class="material-symbols-rounded text-base">restart_alt</span>
                            </button>
                        </div>
                    </div>
                </section>
                <section class="bg-white/5 border border-white/5 rounded-2xl p-4 sm:p-5 hover:bg-white/10 hover:border-cyan-500/30 transition-all duration-300">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full bg-cyan-500/20 flex items-center justify-center text-cyan-300 shrink-0">
                            <span class="material-symbols-rounded text-xl">format_size</span>
                        </div>
                        <div class="w-full overflow-hidden">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-slate-200 font-semibold text-sm">حجم النصوص</p>
                                <span class="bg-slate-800 px-2 py-0.5 rounded text-cyan-300 text-xs font-mono border border-slate-700">
                                    <span id="font-size-number">16</span>px
                                </span>
                            </div>
                            <p id="font-size-preview" class="text-slate-300/90 font-medium mb-3 transition-all origin-right break-words leading-relaxed" style="font-size: var(--base-size);">
                                مثال: هذا نص تجريبي لمعاينة حجم السؤال
                            </p>
                            <p class="text-slate-500 text-[11px] mb-3">يتم تطبيق الحجم مباشرة على أسئلة اللعبة.</p>
                            <input
                                type="range"
                                id="font-size-slider"
                                min="12"
                                max="24"
                                value="16"
                                class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-400 hover:accent-cyan-300 transition-all">
                        </div>
                    </div>
                </section>
                <section class="bg-white/5 border border-white/5 rounded-2xl p-4 sm:p-5 hover:bg-white/10 hover:border-indigo-500/30 transition-all duration-300">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-300">
                            <span class="material-symbols-rounded text-xl">manage_accounts</span>
                        </div>
                        <div>
                            <p class="text-slate-200 font-semibold text-sm">إدارة الحساب</p>
                            <p class="text-slate-500 text-[11px]">تغيير كلمة المرور وتسجيل الخروج</p>
                        </div>
                    </div>
                    <div class="flex gap-2 items-center mb-3">
                        <input
                            type="password"
                            id="settings-new-password"
                            class="flex-1 min-w-0 bg-slate-900/50 border border-slate-700 text-white text-sm rounded-xl px-4 py-2.5 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 placeholder-slate-600 transition"
                            placeholder="كلمة المرور الجديدة...">
                        <button
                            id="btn-update-password"
                            class="shrink-0 whitespace-nowrap bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400 text-white px-5 py-2.5 rounded-xl text-xs font-bold shadow-lg shadow-indigo-500/20 transition transform active:scale-95 h-full flex items-center">
                            حفظ
                        </button>
                    </div>
                    <button
                        id="logout-btn"
                        class="w-full py-3 bg-red-500/10 text-red-400 border border-red-500/10 rounded-xl flex justify-center items-center gap-2 hover:bg-red-500/20 hover:border-red-500/30 transition-all duration-200 font-medium text-sm group">
                        <span class="material-symbols-rounded text-lg group-hover:-translate-x-1 transition-transform">logout</span>
                        تسجيل الخروج من الجلسة
                    </button>
                </section>
                <section class="bg-white/5 border border-white/5 rounded-2xl p-4 sm:p-5 hover:bg-white/10 hover:border-red-500/30 transition-all duration-300">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 rounded-full bg-red-500/15 flex items-center justify-center text-red-300">
                            <span class="material-symbols-rounded text-xl">delete_forever</span>
                        </div>
                        <div>
                            <p class="text-slate-200 font-semibold text-sm">البيانات والتخزين</p>
                            <p class="text-slate-500 text-[11px]">تنظيف الملفات المؤقتة وإعادة تهيئة التطبيق</p>
                        </div>
                    </div>
                    <button id="refresh-question-counts-btn" class="w-full mt-3 bg-slate-900/40 hover:bg-slate-900/60 border border-white/10 text-slate-200 rounded-xl py-3 text-xs font-bold transition active:scale-95 flex items-center justify-center gap-2">
    <span class="material-symbols-rounded text-base text-cyan-300">refresh</span>
    تحديث عدد الأسئلة
</button>
<p class="text-slate-500 text-[11px] mt-2">يعيد حساب عدد الأسئلة من ملفات التطبيق.</p>
<button id="clear-cache-btn" class="w-full mt-3 bg-slate-900/40 hover:bg-slate-900/60 border border-white/10 text-slate-200 rounded-xl py-3 text-xs font-bold transition active:scale-95 flex items-center justify-center gap-2">
    <span class="material-symbols-rounded text-base text-red-300">delete_sweep</span>
    مسح ذاكرة التخزين المؤقتة (Cache)
</button>
<p class="text-slate-500 text-[11px] mt-2">سيؤدي ذلك إلى تسجيل خروجك وحذف البيانات المحلية فقط.</p>                </section>
            </div>
            <div class="shrink-0 px-5 sm:px-6 py-4 border-t border-white/10 bg-slate-900/30">
                <button class="close-modal w-full bg-white/5 hover:bg-white/10 border border-white/10 text-slate-200 rounded-xl py-3 text-sm font-bold transition active:scale-95 flex items-center justify-center gap-2">
                    <span class="material-symbols-rounded text-base">close</span>
                    إغلاق
                </button>
            </div>
        </div>
    </div>
   <div id="about-modal" class="modal-overlay">
    <div class="modal-box border-2 border-amber-500/30 bg-[#0f172a] relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none bg-icon-modal-watermark"></div>
        <div class="text-center mb-6 relative z-10">
            <div class="inline-block p-4 rounded-full border border-amber-500/20 bg-amber-500/5 mb-2">
                <span class="material-symbols-rounded text-amber-400 text-5xl animate-pulse-slow">auto_stories</span>
            </div>
            <h3 class="text-2xl font-bold text-white mt-2 font-heading">هياكل النور</h3>
            <p class="text-amber-400 text-sm font-bold tracking-widest mt-1">رحلة في رحاب النور</p>
        </div>
        <div id="about-content" class="text-slate-300 text-sm leading-loose space-y-4 font-body relative z-10 px-2">
            <p class="text-justify text-shadow-sm">
                ليس مجرد لعبة، بل هو نافذة تطل منها على بساتين المعرفة وتراث العترة الطاهرة. 
                صُمم هذا التطبيق ليكون جسراً يربطك بسيرة المعصومين (ع)، تاريخهم، فقههم، ومناقبهم بأسلوب تفاعلي يمزج بين 
                <span class="text-white font-bold">متعة التحدي وعمق الفائدة</span> والمعلومة الثقافية والدينية العامة.
            </p>
            <div class="h-px w-1/2 mx-auto bg-gradient-to-r from-transparent via-amber-500/50 to-transparent my-4"></div>
            <p class="text-justify">
                هنا.. كل إجابة صحيحة هي خطوة تقربك أكثر، وكل وسام تناله هو <span class="text-amber-400">وسام فخرٍ بمعرفتك</span>. 
                نافس المحبين في لوحة الشرف، واختبر معلوماتك، واجعل من ذكرهم (ع) رفيقاً ليومك.
            </p>
            <div class="mt-8 pt-4 border-t border-slate-700/50 text-center opacity-60">
                <p class="text-[10px] text-slate-400">الإصدار 2.0 • تم التطوير لخدمة نشر علوم آل محمد (ص)</p>
            </div>
        </div>
        <button class="close-modal absolute top-4 left-4 text-slate-400 hover:text-white transition p-2 bg-black/20 rounded-full z-50">X</button>
    </div>
</div>
<div id="privacy-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300" dir="rtl">
        <div class="w-full max-w-md mx-4 bg-[#0f172a] rounded-3xl border border-white/10 shadow-2xl overflow-hidden flex flex-col">
            <div class="px-5 py-4 border-b border-white/10 bg-slate-900/40 relative">
                <div class="flex items-center justify-between gap-3">
                    <h3 class="text-xl font-bold text-white font-heading">
                        🔒 خيارات الخصوصية
                    </h3>
                    <button class="close-modal text-slate-400 hover:text-white rounded-full p-2 transition-all">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
            </div>

            <div class="p-5 space-y-4">
                <div class="bg-white/5 border border-white/5 rounded-2xl p-4 hover:bg-white/10 transition">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center text-amber-300">
                                <span class="material-symbols-rounded">visibility_off</span>
                            </div>
                            <div>
                                <p class="text-slate-200 font-semibold text-sm">إخفاء الحالة “نشط الآن”</p>
                                <p class="text-slate-500 text-[11px]">عدم إظهار حالتك للآخرين</p>
                            </div>
                        </div>

                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="privacy-hide-online-toggle" class="sr-only peer">
                            <div class="w-12 h-6 bg-slate-700 rounded-full peer
                                peer-checked:bg-gradient-to-r peer-checked:from-amber-500 peer-checked:to-yellow-400
                                after:content-[''] after:absolute after:top-[2px] after:right-[2px]
                                after:bg-white after:rounded-full after:h-5 after:w-5 after:shadow-sm
                                after:transition-all peer-checked:after:-translate-x-full"></div>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
<div id="user-modal" class="modal-overlay backdrop-blur-sm">
    <div class="modal-box !bg-[#0f172a] !border-2 !border-amber-500/30 !rounded-3xl !p-0 overflow-hidden shadow-[0_0_60px_rgba(245,158,11,0.15)] max-w-lg w-full flex flex-col max-h-[90vh]">
        <div class="relative bg-slate-900 p-6 text-center border-b border-amber-500/20 shrink-0 overflow-hidden">
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full bg-gradient-to-b from-amber-500/5 to-transparent pointer-events-none"></div>
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-amber-500/10 rounded-full blur-3xl"></div>
            <div class="relative z-10 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-rounded text-amber-500 text-2xl drop-shadow">id_card</span>
                    <h3 class="text-xl font-bold text-white font-heading">بطاقة اللاعب</h3>
                </div>
                <div class="flex items-center gap-2">
                    <button id="guest-auth-btn-user-modal" type="button" class="hidden w-8 h-8 rounded-full bg-slate-800 text-amber-300 hover:text-amber-200 hover:bg-amber-500/10 border border-amber-500/30 transition flex items-center justify-center" title="تسجيل الدخول / التسجيل" aria-label="تسجيل الدخول أو التسجيل" onclick="try{window.openGuestAuth&&window.openGuestAuth()}catch(_){}">
                        <svg class="google-mark" viewBox="0 0 48 48" aria-hidden="true">
                            <path fill="#EA4335" d="M24 9.5c3.54 0 6.73 1.22 9.25 3.62l6.9-6.9C35.97 2.36 30.4 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.05 6.26C12.6 13.06 17.87 9.5 24 9.5z"/>
                            <path fill="#4285F4" d="M46.5 24.5c0-1.58-.14-3.1-.4-4.58H24v8.68h12.65c-.54 2.88-2.16 5.33-4.6 6.97l7.03 5.46C43.7 36.9 46.5 31.3 46.5 24.5z"/>
                            <path fill="#FBBC05" d="M10.61 28.48a14.5 14.5 0 0 1 0-8.96l-8.05-6.26a24 24 0 0 0 0 21.48l8.05-6.26z"/>
                            <path fill="#34A853" d="M24 48c6.4 0 11.77-2.12 15.69-5.77l-7.03-5.46c-1.95 1.31-4.44 2.08-8.66 2.08-6.13 0-11.4-3.56-13.39-8.72l-8.05 6.26C6.51 42.62 14.62 48 24 48z"/>
                        </svg>
                    </button>
                    <button id="btn-back-bag" class="close-modal w-8 h-8 rounded-full bg-slate-800 text-slate-300 hover:text-white hover:bg-slate-700 border border-slate-700 transition flex items-center justify-center" aria-label="رجوع"><span class="material-symbols-rounded text-xl">close</span></button>
                </div>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-6">
            <div class="flex flex-col items-center">
                <div class="relative w-24 h-24 mb-4 group">
                    <div class="absolute inset-0 bg-amber-500/20 rounded-full blur-md group-hover:bg-amber-500/40 transition-all"></div>
                    <img id="profile-img-preview" src="" class="w-full h-full rounded-full object-cover border-2 border-amber-500/50 shadow-xl relative z-10 hidden">
                    <div id="profile-icon-preview" class="w-full h-full rounded-full bg-slate-800 border-2 border-slate-600 flex items-center justify-center relative z-10 shadow-inner">
                        <span class="material-symbols-rounded text-5xl text-slate-500">person</span>
                    </div>
                    <div class="absolute -bottom-2 -right-2 z-20 flex gap-1">
                        <label for="avatar-upload" class="w-8 h-8 rounded-full bg-amber-500 text-slate-900 flex items-center justify-center cursor-pointer hover:bg-amber-400 hover:scale-110 transition shadow-lg border-2 border-[#0f172a]">
                            <span class="material-symbols-rounded text-lg font-bold">photo_camera</span>
                        </label>
                        <button id="delete-custom-avatar" class="hidden w-8 h-8 rounded-full bg-red-500 text-white flex items-center justify-center hover:bg-red-400 hover:scale-110 transition shadow-lg border-2 border-[#0f172a]">
                            <span class="material-symbols-rounded text-lg font-bold">delete</span>
                        </button>
                    </div>
                    <input type="file" id="avatar-upload" accept="image/*" class="hidden">
                </div>
                <div class="w-full max-w-xs text-center space-y-2">
                    <label class="text-[10px] text-amber-500 font-bold uppercase tracking-widest">الاسم الظاهر</label>
                    <div class="relative">
                        <input type="text" id="edit-username" class="w-full bg-slate-900 border border-slate-700 text-white text-center font-bold text-lg rounded-xl py-3 px-4 focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition-all placeholder-slate-600" placeholder="أدخل اسمك">
                        <span class="material-symbols-rounded absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none">edit</span>
                    </div>
                    <div class="pt-2">
                        <label class="text-[10px] text-amber-500 font-bold uppercase tracking-widest">الجنس</label>
                        <div class="mt-2 flex justify-center gap-6">
                            <label class="flex items-center text-sm text-white cursor-pointer">
                                <input type="radio" name="edit-gender" id="edit-gender-male" value="male" class="peer sr-only">
                                <span class="flex items-center justify-center w-12 h-12 rounded-xl border border-slate-700 bg-slate-900/40 opacity-70 transition-all peer-checked:opacity-100 peer-checked:border-amber-500 peer-checked:ring-2 peer-checked:ring-amber-500">
                                    <img src="icon/man.svg" alt="ذكر" class="w-7 h-7">
                                </span>
                            </label>
                            <label class="flex items-center text-sm text-white cursor-pointer">
                                <input type="radio" name="edit-gender" id="edit-gender-female" value="female" class="peer sr-only">
                                <span class="flex items-center justify-center w-12 h-12 rounded-xl border border-slate-700 bg-slate-900/40 opacity-70 transition-all peer-checked:opacity-100 peer-checked:border-amber-500 peer-checked:ring-2 peer-checked:ring-amber-500">
                                    <img src="icon/woman.svg" alt="أنثى" class="w-7 h-7">
                                </span>
                            </label>
                        </div>
                    </div>
                    <p id="profile-join-date" class="text-[10px] text-slate-500 font-mono dir-ltr">Join Date: ...</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-slate-800/50 p-3 rounded-2xl border border-slate-700 flex items-center gap-3 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-amber-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="w-10 h-10 rounded-xl bg-amber-500/10 flex items-center justify-center text-amber-400 border border-amber-500/20 shadow-[0_0_10px_rgba(245,158,11,0.1)]">
                        <span class="material-symbols-rounded">monetization_on</span>
                    </div>
                    <div>
                        <span class="text-[10px] text-slate-400 block font-bold">النقاط</span>
                        <span id="profile-stat-score" class="text-lg font-bold text-white font-mono">0</span>
                    </div>
                </div>
                <div class="bg-slate-800/50 p-3 rounded-2xl border border-slate-700 flex items-center gap-3 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-blue-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="w-10 h-10 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-400 border border-blue-500/20 shadow-[0_0_10px_rgba(59,130,246,0.1)]">
                        <span class="material-symbols-rounded">sports_esports</span>
                    </div>
                    <div>
                        <span class="text-[10px] text-slate-400 block font-bold">جولات</span>
                        <span id="profile-stat-played" class="text-lg font-bold text-white font-mono">0</span>
                    </div>
                </div>
                <div class="bg-slate-800/50 p-3 rounded-2xl border border-slate-700 flex items-center gap-3 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-green-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="w-10 h-10 rounded-xl bg-green-500/10 flex items-center justify-center text-green-400 border border-green-500/20 shadow-[0_0_10px_rgba(34,197,94,0.1)]">
                        <span class="material-symbols-rounded">check_circle</span>
                    </div>
                    <div>
                        <span class="text-[10px] text-slate-400 block font-bold">الاجابات الصحيحة</span>
                        <span id="profile-stat-correct" class="text-lg font-bold text-white font-mono">0</span>
                    </div>
                </div>
                <div class="bg-slate-800/50 p-3 rounded-2xl border border-slate-700 flex items-center gap-3 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="w-10 h-10 rounded-xl bg-purple-500/10 flex items-center justify-center text-purple-400 border border-purple-500/20 shadow-[0_0_10px_rgba(168,85,247,0.1)]">
                        <span class="material-symbols-rounded">percent</span>
                    </div>
                    <div>
                        <span class="text-[10px] text-slate-400 block font-bold">الدقة</span>
                        <span id="profile-stat-accuracy" class="text-lg font-bold text-white font-mono">0%</span>
                    </div>
                </div>
            </div>
            <div>
                <h4 class="text-xs text-slate-400 font-bold mb-3 flex items-center gap-2">
                    <span class="w-1 h-4 bg-amber-500 rounded-full"></span>
                    الأوسمة المكتسبة
                </h4>
                <div id="profile-badges-display" class="grid grid-cols-3 gap-3 p-4 bg-slate-900/50 rounded-2xl border border-slate-800 min-h-[100px] items-center justify-center text-center">
                    </div>
            </div>
        </div>
        <div class="p-5 bg-slate-900 border-t border-amber-500/20 mt-auto shrink-0">
            <button id="save-user-btn" class="w-full py-3 rounded-xl bg-gradient-to-r from-amber-600 to-amber-500 text-white font-bold shadow-lg shadow-amber-500/20 hover:shadow-amber-500/40 hover:-translate-y-1 transition-all flex justify-center items-center gap-2 active:scale-95">
                <span class="material-symbols-rounded">save</span>
                حفظ التعديلات
            </button>
        </div>
    </div>
</div>
    <div id="selection-modal" class="modal-overlay selection-modal-overlay">
        <div class="modal-box selection-modal-box">
            <div class="selection-modal-header flex justify-between items-center">
                <h3 id="selection-title" class="text-xl font-bold text-amber-400 font-heading">اختر القائمة</h3>
                <button class="close-modal selection-modal-close" aria-label="إغلاق">✕</button>
            </div>
            <div id="selection-list-container" class="selection-modal-list flex flex-col"></div>
        </div>
    </div>
<div id="bag-modal" class="hidden bag-page">
    <div class="modal-box !bg-[#0f172a] !border-2 !border-amber-500/30 !rounded-3xl !p-0 overflow-hidden shadow-[0_0_60px_rgba(245,158,11,0.15)] max-w-lg w-full flex flex-col h-[85vh] bag-page-box">
        <div class="relative bg-slate-900 p-5 text-center border-b border-amber-500/20 shrink-0 bag-page-header">
            <div class="flex justify-between items-center relative z-10">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-rounded text-amber-500 text-2xl drop-shadow-[0_0_10px_rgba(245,158,11,0.5)]">local_mall</span>
                    <h3 class="text-xl font-bold text-white font-heading">الخزينة والمتجر</h3>
                </div>
                <button class="close-modal w-8 h-8 rounded-full bg-slate-800 text-slate-400 hover:text-white hover:bg-red-500/20 hover:border-red-500/50 border border-slate-700 transition flex items-center justify-center">✕</button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto custom-scrollbar p-5 bag-page-body">
            <div class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-amber-900/40 to-slate-800 border border-amber-500/30 p-4 mb-6 group bag-wallet-card">
                <div class="absolute -right-6 -bottom-6 w-24 h-24 bg-amber-500/10 rounded-full blur-2xl group-hover:bg-amber-500/20 transition-colors"></div>
                <div class="relative z-10 flex justify-between items-center">
                    <div>
                        <span class="text-slate-400 text-xs font-bold block mb-1">رصيدك الحالي</span>
                        <div class="flex items-center gap-2">
                            <span id="bag-user-score" class="text-3xl font-bold text-white font-heading tracking-wider">0</span>
                            <span class="material-symbols-rounded text-amber-400 text-xl animate-pulse-slow">monetization_on</span>
                        </div>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-amber-500/10 flex items-center justify-center border border-amber-500/30 shadow-[0_0_15px_rgba(245,158,11,0.2)]">
                        <span class="material-symbols-rounded text-amber-400 text-2xl">account_balance_wallet</span>
                    </div>
                </div>
            </div>
            <div class="flex p-1 bg-slate-900 rounded-xl mb-6 border border-slate-700 relative bag-tabs">
                <button id="tab-inventory" class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all duration-300 relative z-10 bg-amber-500 text-black shadow-lg">
                    مقتنياتي
                </button>
                <button id="tab-shop" class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all duration-300 relative z-10 text-slate-400 hover:text-white">
                    المتجر
                </button>
            </div>
            <div id="inventory-view" class="space-y-6 animate-fade-in">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700/50 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-red-500/10 flex items-center justify-center text-red-500 border border-red-500/20">
                            <span class="material-symbols-rounded">favorite</span>
                        </div>
                        <div>
                            <span class="text-[10px] text-slate-400 block">قلوب</span>
                            <span id="inv-lives-count" class="text-lg font-bold text-white">0</span>
                        </div>
                    </div>
                    <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700/50 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-400 border border-blue-500/20">
                            <span class="material-symbols-rounded">percent</span>
                        </div>
                        <div>
                            <span class="text-[10px] text-slate-400 block">50/50</span>
                            <span id="inv-fifty-count" class="text-lg font-bold text-white">0</span>
                        </div>
                    </div>
                    <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700/50 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-yellow-500/10 flex items-center justify-center text-yellow-400 border border-yellow-500/20">
                            <span class="material-symbols-rounded">lightbulb</span>
                        </div>
                        <div>
                            <span class="text-[10px] text-slate-400 block">تلميحات</span>
                            <span id="inv-hint-count" class="text-lg font-bold text-white">0</span>
                        </div>
                    </div>
                    <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700/50 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center text-green-400 border border-green-500/20">
                            <span class="material-symbols-rounded">skip_next</span>
                        </div>
                        <div>
                            <span class="text-[10px] text-slate-400 block">تخطي</span>
                            <span id="inv-skip-count" class="text-lg font-bold text-white">0</span>
                        </div>
                    </div>
                </div>
                </div>
            <div id="shop-view" class="hidden space-y-6 animate-fade-in">
                <div>
                    <h4 class="text-amber-400 text-xs font-bold mb-3 flex items-center gap-1 opacity-80 uppercase tracking-widest">
                        مستلزمات اللعب
                    </h4>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.buyShopItem('life', 120)" class="group relative bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-red-500/50 hover:bg-slate-700/80 transition-all text-center overflow-hidden">
                             <div class="absolute inset-0 bg-red-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                             <span class="material-symbols-rounded text-red-500 text-3xl mb-2 group-hover:scale-110 transition-transform block">favorite</span>
                             <p class="text-white text-sm font-bold">قلب إضافي</p>
                             <div class="mt-3 inline-flex items-center gap-1 bg-slate-900/80 px-2 py-1 rounded-lg border border-slate-600 group-hover:border-red-500/30 transition-colors">
                                <span class="text-amber-400 font-bold text-xs">120</span>
                                <span class="material-symbols-rounded text-amber-400 text-[10px]">monetization_on</span>
                             </div>
                        </button>
                        <button onclick="window.buyShopItem('fifty', 80)" class="group relative bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-blue-500/50 hover:bg-slate-700/80 transition-all text-center overflow-hidden">
                             <div class="absolute inset-0 bg-blue-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                             <span class="material-symbols-rounded text-blue-400 text-3xl mb-2 group-hover:scale-110 transition-transform block">percent</span>
                             <p class="text-white text-sm font-bold">50/50</p>
                             <div class="mt-3 inline-flex items-center gap-1 bg-slate-900/80 px-2 py-1 rounded-lg border border-slate-600 group-hover:border-blue-500/30 transition-colors">
                                <span class="text-amber-400 font-bold text-xs">80</span>
                                <span class="material-symbols-rounded text-amber-400 text-[10px]">monetization_on</span>
                             </div>
                        </button>
                        <button onclick="window.buyShopItem('hint', 60)" class="group relative bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-yellow-400/50 hover:bg-slate-700/80 transition-all text-center overflow-hidden">
                             <div class="absolute inset-0 bg-yellow-400/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                             <span class="material-symbols-rounded text-yellow-400 text-3xl mb-2 group-hover:scale-110 transition-transform block">lightbulb</span>
                             <p class="text-white text-sm font-bold">تلميح</p>
                             <div class="mt-3 inline-flex items-center gap-1 bg-slate-900/80 px-2 py-1 rounded-lg border border-slate-600 group-hover:border-yellow-400/30 transition-colors">
                                <span class="text-amber-400 font-bold text-xs">60</span>
                                <span class="material-symbols-rounded text-amber-400 text-[10px]">monetization_on</span>
                             </div>
                        </button>
                        <button onclick="window.buyShopItem('skip', 100)" class="group relative bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-green-400/50 hover:bg-slate-700/80 transition-all text-center overflow-hidden">
                             <div class="absolute inset-0 bg-green-400/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                             <span class="material-symbols-rounded text-green-400 text-3xl mb-2 group-hover:scale-110 transition-transform block">skip_next</span>
                             <p class="text-white text-sm font-bold">تخطي</p>
                             <div class="mt-3 inline-flex items-center gap-1 bg-slate-900/80 px-2 py-1 rounded-lg border border-slate-600 group-hover:border-green-400/30 transition-colors">
                                <span class="text-amber-400 font-bold text-xs">100</span>
                                <span class="material-symbols-rounded text-amber-400 text-[10px]">monetization_on</span>
                             </div>
                        </button>
                    </div>
                </div>
                </div>
        </div>
    </div>
</div>
    <div id="toast-notification" class="hidden"></div>
    <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-50"></canvas>
<div id="marathon-rules-modal" class="modal-overlay">
    <div class="modal-box border-2 border-slate-400/50">
        <h3 class="text-2xl font-bold text-white mb-4 font-heading text-center"> قواعد أكمل النور</h3>
        <div class="space-y-3 p-4 bg-slate-800/60 rounded-lg border border-slate-700 mb-6">
    <p class="text-slate-300 text-sm flex items-start gap-2">
        <span class="material-symbols-rounded text-sky-400 mt-1 shrink-0">lock_clock</span>
        متاح مرة واحدة كل <span class="font-bold text-white">٢٤ ساعة</span>.
    </p>
    <p class="text-slate-300 text-sm flex items-start gap-2">
        <span class="material-symbols-rounded text-orange-400 mt-1 shrink-0">history_edu</span>
        إذا كان لديك بنك أخطاء، راجعه أولاً قبل البدء.
    </p>
    <p class="text-slate-300 text-sm flex items-start gap-2">
        <span class="material-symbols-rounded text-red-400 mt-1 shrink-0">favorite</span>
        تبدأ الجولة بـ٣ قلوب، والخطأ يخصم قلبًا.
    </p>
    <p class="text-slate-300 text-sm flex items-start gap-2">
        <span class="material-symbols-rounded text-emerald-400 mt-1 shrink-0">quiz</span>
        الأسئلة من القرآن الكريم وتنتهي الجولة عند نفاد الأسئلة أو القلوب.
    </p>
    <p class="text-xs text-amber-500 font-bold mt-4 border-t border-slate-700 pt-3">
        المساعدات (حذف/تخطي) متاحة بالتكلفة العادية.
    </p>
</div>
        <button id="btn-marathon-confirm" class="btn-gold-action w-full py-3">بدء التحدي الآن!</button>
        <button class="close-modal w-full text-slate-500 hover:text-white mt-3 text-sm transition">إلغاء</button>
    </div>
</div>
<div id="truefalse-rules-modal" class="modal-overlay">
    <div class="modal-box border-2 border-amber-500/50 bg-[#0f172a]">
        <h3 class="text-2xl font-bold text-white mb-4 font-heading text-center">تحدي صح أو خطأ</h3>
        <div class="space-y-3 p-4 bg-slate-800/60 rounded-lg border border-slate-700 mb-5">
            <p class="text-slate-300 text-sm flex items-start gap-2">
                <span class="material-symbols-rounded text-amber-400 mt-1 shrink-0">favorite</span>
                نفس منطق القلوب: الخطأ يخصم قلباً، وتنتهي الجولة عند نفاد القلوب.
            </p>
            <p class="text-slate-300 text-sm flex items-start gap-2">
                <span class="material-symbols-rounded text-emerald-400 mt-1 shrink-0">workspace_premium</span>
                واجهة اللعب والنتيجة مطابقة للتحديات الأخرى (فوز/خسارة + مراجعة الأخطاء).
            </p>
            <p class="text-slate-300 text-sm flex items-start gap-2">
                <span class="material-symbols-rounded text-sky-400 mt-1 shrink-0">lock_clock</span>
                لن تتكرر الأسئلة التي تم عرضها لك حتى تُكمل الختم (إلا في وضع المراجعة).
            </p>
            <p class="text-xs text-amber-500 font-bold mt-4 border-t border-slate-700 pt-3">
                ملاحظة: تم تعطيل المساعدات هنا لأن الخيارات خياران فقط.
            </p>
        </div>
        <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 mb-5">
            <div class="flex justify-between items-center text-xs text-slate-300 mb-2">
                <span class="font-bold">تقدّم الختم</span>
                <span id="tf-modal-progress-text" class="font-bold text-white">0/0</span>
            </div>
            <div class="h-2 rounded-full bg-slate-900/60 border border-amber-500/20 overflow-hidden">
                <div id="tf-modal-progress-fill" class="h-full w-0 bg-gradient-to-l from-amber-400/90 to-amber-600/70 transition-all duration-300"></div>
            </div>
            <div class="flex justify-between items-center mt-2 text-[10px] hidden">
                <span id="tf-modal-remaining" class="text-amber-400/90 font-bold">متبقي 0</span>
                <button id="tf-reset-progress" class="text-slate-400 hover:text-white underline decoration-dotted">إعادة ضبط الختم</button>
            </div>
        </div>
        <div class="mb-6 hidden">
            <p class="text-xs text-slate-400 mb-2 font-bold">اختر طول الجولة</p>
            <div class="grid grid-cols-3 gap-2">
                <button class="tf-round-btn bg-slate-800 text-white py-2 rounded-xl border border-slate-700 hover:border-amber-500/40 hover:bg-slate-700 transition font-heading text-sm" data-count="10">10</button>
                <button class="tf-round-btn bg-slate-800 text-white py-2 rounded-xl border border-slate-700 hover:border-amber-500/40 hover:bg-slate-700 transition font-heading text-sm" data-count="15">15</button>
                <button class="tf-round-btn bg-slate-800 text-white py-2 rounded-xl border border-slate-700 hover:border-amber-500/40 hover:bg-slate-700 transition font-heading text-sm" data-count="all">كامل</button>
            </div>
            <p id="tf-modal-note" class="text-[10px] text-slate-400 mt-2">الجولة «كامل» تلعب كل الأسئلة المتبقية حتى نهاية الختم.</p>
        </div>
        <button id="btn-tf-confirm" class="btn-gold-action w-full py-3">بدء الجولة</button>
        <button class="close-modal w-full text-slate-500 hover:text-white mt-3 text-sm transition">إلغاء</button>
    </div>
</div>
<script type="module" src="js/monasbat_banner.js"></script>
    <script type="module" src="js/main.js"></script>
            <div id="confirm-modal" class="modal-overlay z-[90]">
        <div class="modal-box border-2 border-amber-500/50 text-center bg-[#0f172a]">
            <div class="mb-4 flex justify-center">
                <span id="confirm-icon" class="material-symbols-rounded text-5xl text-amber-400 animate-bounce">help</span>
            </div>
            <h3 id="confirm-title" class="text-2xl font-bold text-white mb-2 font-heading">تأكيد الإجراء</h3>
            <p id="confirm-msg" class="text-slate-300 text-sm mb-6 leading-relaxed">...</p>
            <div class="flex gap-3 justify-center">
                <button id="btn-confirm-yes" class="btn-gold-action w-1/2 py-2 text-sm">نعم، متأكد</button>
                <button id="btn-confirm-no" class="bg-slate-700 text-white w-1/2 rounded-xl border border-slate-600 hover:bg-slate-600 transition font-heading">إلغاء</button>
            </div>
        </div>
    </div>
    <div id="force-review-modal" class="modal-overlay z-[80]">
        <div class="modal-box border-2 border-orange-500/50 text-center bg-[#0f172a]">
            <div class="mb-4 flex justify-center">
                <span class="material-symbols-rounded text-5xl text-orange-400 animate-pulse">history_edu</span>
            </div>
            <h3 class="text-xl font-bold text-white mb-2 font-heading">تنبيه هام</h3>
            <p class="text-slate-300 text-sm mb-6 leading-relaxed">لديك أسئلة سابقة أخطأت فيها.<br>يجب مراجعتها وتصحيحها أولاً قبل بدء تحدي جديد!</p>
            <div class="flex gap-3 justify-center">
                <button id="btn-force-review-confirm" class="btn-gold-action w-1/2 py-2 text-sm">مراجعة الآن</button>
                <button class="close-modal bg-slate-700 text-white w-1/2 rounded-xl border border-slate-600 hover:bg-slate-600 transition font-heading">إلغاء</button>
            </div>
        </div>
    </div>
<div id="reward-modal" class="modal-overlay z-[80]">
    <div class="modal-box border-2 border-amber-500/50 bg-[#0f172a] text-center">
        <div id="reward-content-area" class="reward-modal-content">
            </div>
        <button onclick="document.getElementById('reward-modal').classList.remove('active'); playSound('click');" class="btn-gold-action w-full mt-4">استلام الجوائز</button>
    </div>
</div>
<div id="pwa-install-modal" class="modal-overlay z-[80]">
    <div class="modal-box border-2 border-amber-500/50 text-center bg-[#0f172a] relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-b from-amber-500/10 to-transparent pointer-events-none"></div>
        <div class="mb-4 flex justify-center relative z-10">
            <span class="material-symbols-rounded text-5xl text-amber-400 animate-bounce">download</span>
        </div>
        <h3 class="text-2xl font-bold text-white mb-2 font-heading relative z-10">ثبّت التطبيق الآن</h3>
        <p id="pwa-install-msg" class="text-slate-300 text-sm mb-6 leading-relaxed relative z-10">ثبّت التطبيق على هاتفك للوصول السريع والعمل بسلاسة.</p>
        <div class="relative z-10 flex flex-col gap-3">
            <button id="btn-pwa-install" class="btn-gold-action w-full py-3">تثبيت التطبيق</button>
            <button id="btn-pwa-install-close" class="w-full text-slate-500 hover:text-white text-sm transition font-heading">لاحقًا</button>
        </div>
    </div>
</div>
<div id="update-available-modal" class="modal-overlay z-[80]">
    <div class="modal-box border-2 border-amber-500/50 text-center bg-[#0f172a] relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-b from-amber-500/10 to-transparent pointer-events-none"></div>
        <div class="mb-4 flex justify-center relative z-10">
            <span class="material-symbols-rounded text-5xl text-amber-400 animate-bounce">system_update</span>
        </div>
        <h3 class="text-2xl font-bold text-white mb-2 font-heading relative z-10">تحديث متاح</h3>
        <p class="text-slate-300 text-sm mb-6 leading-relaxed relative z-10">تتوفر نسخة جديدة من التطبيق. اضغط تحديث الآن لتفعيلها.</p>
        <div class="relative z-10 flex gap-3 justify-center">
            <button id="btn-update-now" class="btn-gold-action w-1/2 py-2 text-sm">تحديث الآن</button>
            <button id="btn-update-later" class="bg-slate-700 text-white w-1/2 rounded-xl border border-slate-600 hover:bg-slate-600 transition font-heading">لاحقًا</button>
        </div>
    </div>
</div>
<script>
    (function () {
        const isStandalone =
            (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
            (window.matchMedia && window.matchMedia('(display-mode: fullscreen)').matches) ||
            (window.matchMedia && window.matchMedia('(display-mode: minimal-ui)').matches) ||
            window.navigator.standalone === true;
        if (isStandalone) return;
        const modal = document.getElementById('pwa-install-modal');
        const btnInstall = document.getElementById('btn-pwa-install');
        const btnClose = document.getElementById('btn-pwa-install-close');
        const msg = document.getElementById('pwa-install-msg');
        if (!modal || !btnInstall) return;
        const ua = (navigator.userAgent || '').toLowerCase();
        const isIOS = /iphone|ipad|ipod/.test(ua);
        let deferredPrompt = null;
        function showInstallModal() { modal.classList.add('active'); }
        function hideInstallModal() { modal.classList.remove('active'); }
        window.addEventListener('load', () => {
            if (isIOS && msg) {
                msg.innerHTML = 'للتثبيت على iPhone: اضغط زر المشاركة ثم اختر <b>إضافة إلى الشاشة الرئيسية</b>.';
                btnInstall.textContent = 'طريقة التثبيت';
                btnInstall.disabled = false;
                showInstallModal();
            } else {
                btnInstall.disabled = true;
                btnInstall.textContent = 'تثبيت التطبيق';
            }
        });
        if (btnClose) btnClose.addEventListener('click', hideInstallModal);
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            btnInstall.disabled = false;
            btnInstall.textContent = 'تثبيت التطبيق';
            if (msg) msg.textContent = 'ثبّت التطبيق على هاتفك للوصول السريع والعمل بسلاسة.';
            showInstallModal();
        });
        window.addEventListener('appinstalled', () => {
            hideInstallModal();
        });
        btnInstall.addEventListener('click', async () => {
            if (isIOS) return;
            if (!deferredPrompt) {
                if (msg) msg.innerHTML = 'التثبيت غير متاح الآن. افتح الموقع من <b>Google Chrome</b> أو أعد المحاولة لاحقًا.';
                return;
            }
            try {
                deferredPrompt.prompt();
                const choice = await deferredPrompt.userChoice;
                if (choice && choice.outcome === 'dismissed') return;
            } catch (_) {}
            deferredPrompt = null;
            hideInstallModal();
        });
    })();
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const updateModal = document.getElementById('update-available-modal');
            const btnUpdateNow = document.getElementById('btn-update-now');
            const btnUpdateLater = document.getElementById('btn-update-later');
            let refreshing = false;

            function showUpdateModal() { if (updateModal) updateModal.classList.add('active'); }
            function hideUpdateModal() { if (updateModal) updateModal.classList.remove('active'); }

            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('SW Registered:', registration.scope);

                    if (btnUpdateLater) btnUpdateLater.addEventListener('click', hideUpdateModal);
                    if (btnUpdateNow) btnUpdateNow.addEventListener('click', () => {
                        if (registration.waiting) {
                            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                            hideUpdateModal();
                        }
                    });

                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        if (refreshing) return;
                        refreshing = true;
                        window.location.reload();
                    });

                    if (registration.waiting && navigator.serviceWorker.controller) {
                        showUpdateModal();
                    }

                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (!newWorker) return;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateModal();
                            }
                        });
                    });
                })
                .catch(err => console.log('SW Registration Failed:', err));
        });
    }
</script>
    <div id="low-health-vignette" class="pointer-events-none fixed inset-0 z-[60] opacity-0 transition-opacity duration-500"></div>
<div id="daily-reward-modal" class="modal-overlay z-[80]">
    <div class="modal-box border-2 border-amber-500/50 text-center bg-[#0f172a] relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-amber-500/10 to-transparent pointer-events-none"></div>
        <div class="mb-6 relative z-10 mt-4">
            <div class="inline-block p-2 rounded-full bg-amber-500/5 border border-amber-500/20 mb-2 animate-bounce">
                <img src="Pic/33.png" 
                     class="w-24 h-24 object-contain drop-shadow-[0_0_20px_rgba(251,191,36,0.5)]" 
                     alt="Daily Reward">
            </div>
        </div>
        <h3 class="text-3xl font-bold text-white mb-2 font-heading">هديتك اليومية</h3>
        <p class="text-slate-300 text-sm mb-6 leading-relaxed">أهلاً بعودتك <br> </p>
        <div class="bg-slate-800/60 p-4 rounded-xl border border-slate-700 mb-6 flex justify-center gap-4">
            <div class="text-center">
                <span class="block text-amber-400 font-bold text-2xl font-heading">+200</span>
                <span class="text-[10px] text-slate-400">نقطة</span>
            </div>
            <div class="w-px h-10 bg-slate-600"></div>
            <div class="text-center">
                <span class="block text-red-500 font-bold text-2xl font-heading">+1</span>
                <span class="text-[10px] text-slate-400">قلب</span>
            </div>
        </div>
        <button onclick="window.claimDailyReward()" class="btn-gold-action w-full py-3 text-lg shadow-lg relative overflow-hidden group">
            <span class="relative z-10">استلام المكافأة</span>
            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition duration-300"></div>
        </button>
    </div>
</div>
<div id="quest-modal" class="modal-overlay z-[80] backdrop-blur-sm">
    <div class="modal-box w-full max-w-md bg-[#0f172a] p-0 border border-amber-500/30 rounded-3xl relative overflow-hidden shadow-[0_0_60px_rgba(0,0,0,0.6)] flex flex-col max-h-[85vh]">
        <div class="relative px-5 py-4 flex items-center justify-between bg-slate-900 border-b border-white/5 shrink-0">
            <div class="absolute inset-0 bg-gradient-to-r from-amber-500/5 to-transparent pointer-events-none"></div>
            <div class="flex items-center gap-4 relative z-10">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-slate-800 to-slate-950 border border-amber-500/30 flex items-center justify-center shadow-lg group">
                    <span class="material-symbols-rounded text-2xl text-amber-400 group-hover:scale-110 transition-transform">assignment_turned_in</span>
                </div>
                <div class="text-right">
                    <h2 class="text-lg font-bold text-white tracking-wide">المهام اليومية</h2>
                    <p class="text-[11px] text-amber-500/80 font-bold">«اضغط على المهمة وانتقل للإنجاز»</p>
                </div>
            </div>
            <button id="close-quest-btn" class="text-slate-500 hover:text-white transition p-2 bg-slate-800 hover:bg-red-500/20 rounded-lg border border-slate-700 hover:border-red-500/50">
                <span class="material-symbols-rounded text-lg">close</span>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 relative scrollbar-thin scrollbar-thumb-amber-900/50 scrollbar-track-transparent">
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full max-w-[200px] bg-amber-500/5 blur-[50px] pointer-events-none"></div>
            <div id="quest-list-container" class="quest-list space-y-3 min-h-[150px] relative z-10">
                </div>
        </div>
        <div id="grand-prize-area" class="quest-grand-prize hidden shrink-0 relative z-20">
            <div class="h-px w-full bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
            <div class="p-4 bg-slate-900/95 backdrop-blur-xl">
                <div class="flex items-center justify-between gap-3 bg-amber-500/10 border border-amber-500/20 p-3 rounded-xl mb-3">
                    <div class="text-right">
                        <span class="block text-white font-bold text-xs">الجائزة الكبرى</span>
                        <span class="text-[10px] text-amber-400">مكافأة إتمام جميع المهام</span>
                    </div>
                    <span class="material-symbols-rounded text-amber-400 animate-pulse">stars</span>
                </div>
                <button id="claim-grand-prize-btn" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-amber-600 via-yellow-500 to-amber-600 text-slate-900 font-bold shadow-lg hover:shadow-amber-500/20 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                    <span>استلام المكافأة</span>
                    <span class="material-symbols-rounded text-lg">redeem</span>
                </button>
            </div>
        </div>
    </div>
</div>
<div id="unlock-modal" class="modal-overlay hidden">
    <div class="modal-box border-2 border-amber-500/50 bg-slate-900 w-full max-w-sm">
        <div class="text-center mb-6">
            <span class="material-symbols-rounded text-amber-500 text-6xl mb-2">lock_clock</span>
            <h3 class="text-xl font-bold text-white font-heading">الملف مختوم</h3>
            <p class="text-slate-400 text-sm mt-2 leading-relaxed">
                لقد أتممت هذا القسم سابقاً.<br>
                يفتح مجاناً بعد: <span id="unlock-timer" class="text-green-400 font-bold font-mono">-- يوم</span>
            </p>
        </div>
        <div class="space-y-3">
            <button id="btn-pay-unlock" class="w-full bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-black font-bold p-3 rounded-xl flex justify-between items-center shadow-lg group transition-all">
                <span class="flex items-center gap-2">
                    <span class="material-symbols-rounded">key</span> فتح الآن
                </span>
                <span class="bg-black/20 px-3 py-1 rounded text-xs flex items-center gap-1">
                    99,999 <span class="material-symbols-rounded text-[10px]">monetization_on</span>
                </span>
            </button>
            <button onclick="const m=document.getElementById('unlock-modal'); m.classList.remove('active'); setTimeout(()=>m.classList.add('hidden'), 300);" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 p-3 rounded-xl transition">
    سأنتظر (إغلاق)
</button>
        </div>
    </div>
</div>
<div id="ban-modal" class="modal-overlay hidden">
    <div class="modal-box border-2 border-red-500/50 bg-slate-900 w-full max-w-md">
        <div class="text-center mb-5">
            <span class="material-symbols-rounded text-red-400 text-6xl mb-2">gpp_bad</span>
            <h3 class="text-xl font-bold text-white font-heading">تم حظرك</h3>
            <p class="text-slate-400 text-sm mt-2 leading-relaxed">
                لا يمكنك استخدام التطبيق حالياً.
            </p>
        </div>
        <div class="bg-slate-950/40 border border-slate-700/50 rounded-xl p-4 space-y-2">
            <div class="text-xs text-slate-400">السبب:</div>
            <div id="ban-reason-text" class="text-sm text-white font-bold leading-relaxed">--</div>
            <div class="h-px w-full bg-slate-800 my-2"></div>
            <div class="grid grid-cols-2 gap-3 text-right">
                <div>
                    <div class="text-[10px] text-slate-500">ينتهي في</div>
                    <div id="ban-until-text" class="text-xs text-amber-400 font-bold">--</div>
                </div>
                <div>
                    <div class="text-[10px] text-slate-500">المدة المتبقية</div>
                    <div id="ban-remaining-text" class="text-xs text-green-400 font-bold font-mono" dir="ltr">--</div>
                </div>
            </div>
        </div>
        <div class="space-y-3 mt-5">
            <button id="btn-refresh-ban" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-200 p-3 rounded-xl transition flex items-center justify-center gap-2">
                <span class="material-symbols-rounded">refresh</span>
                تحديث الحالة
            </button>
            <button id="btn-logout-ban" class="w-full bg-red-900/40 hover:bg-red-900 text-red-200 p-3 rounded-xl transition flex items-center justify-center gap-2 border border-red-500/30">
                <span class="material-symbols-rounded">logout</span>
                تسجيل خروج
            </button>
        </div>
    </div>
</div>
<template id="option-template">
    <button class="option-btn option-btn-modern group relative overflow-hidden w-full p-3 mb-2 rounded-xl border border-slate-700 bg-slate-800/80 hover:bg-slate-700 hover:border-amber-500/50 transition-all duration-200 flex items-center gap-4 text-right">
        <span class="option-char flex items-center justify-center w-10 h-10 rounded-lg bg-slate-900 border border-slate-700 text-slate-400 font-bold group-hover:text-amber-400 group-hover:border-amber-500/50 transition-colors shrink-0 font-mono shadow-inner">
            1
        </span>
        <span class="option-text font-bold text-lg flex-1 relative z-10 group-hover:text-white transition-colors leading-relaxed">
            نص الإجابة هنا
        </span>
        <div class="progress-fill absolute inset-0 bg-amber-500/10 translate-x-full transition-transform duration-300 pointer-events-none"></div>
        <span class="status-icon material-symbols-rounded text-2xl hidden relative z-10 ml-2">check_circle</span>
    </button>
</template>
<template id="tf-option-template">
    <button class="option-btn tf-option-btn group relative overflow-hidden w-full rounded-2xl border border-slate-700 bg-slate-900/60 hover:bg-slate-800/90 transition-all duration-200 flex flex-col items-center justify-center py-6">
        <span class="tf-option-icon material-symbols-rounded text-5xl mb-2 opacity-90">check_circle</span>
        <span class="tf-option-text font-heading text-2xl font-bold">صح</span>
        <div class="progress-fill absolute inset-0 bg-amber-500/10 translate-x-full transition-transform duration-300 pointer-events-none"></div>
        <span class="status-icon material-symbols-rounded text-3xl hidden absolute top-3 left-3">check_circle</span>
    </button>
</template>
<template id="leaderboard-row-template">
    <div class="leaderboard-row flex justify-between items-center p-3 mb-3 rounded-xl border-2 transition transform hover:scale-[1.01] cursor-pointer group hover:bg-slate-700 relative">
        <div class="flex items-center gap-3 min-w-0 flex-1">
            <div class="rank-icon flex items-center justify-center min-w-[40px] shrink-0 text-2xl drop-shadow-md"></div>
            <div class="player-avatar-container flex items-center justify-center shrink-0 relative z-10 w-10 h-10">
                    <span class="player-level-badge absolute bottom-0.5 right-0.5 inline-flex items-center justify-center w-4 h-4 rounded-full bg-amber-400 text-[#0f172a] text-[9px] font-black border border-slate-900/80 shadow-[0_0_6px_rgba(251,191,36,0.35)] z-20 pointer-events-none">١</span>
                </div>
            <div class="flex flex-col overflow-hidden w-full justify-center">
                <div class="flex items-center gap-2 min-w-0">
                    <span class="player-name text-white font-bold group-hover:text-amber-400 transition whitespace-nowrap overflow-hidden text-ellipsis min-w-0">
                        اسم اللاعب
                    </span>
                </div>
                <div class="player-status flex items-center gap-1.5 mt-1">
                    <span class="status-dot w-2 h-2 rounded-full inline-block"></span>
                    <span class="status-text text-[9px] opacity-80 leading-none pt-0.5"></span>
                </div>
            </div>
        </div>
        <div class="text-center pl-2 shrink-0 min-w-[60px]">
            <span class="player-score text-yellow-400 font-mono font-bold text-lg block leading-none text-shadow">0</span>
        </div>
    </div>
</template>
<template id="quest-item-template">
    <div class="quest-item group flex items-center gap-3 p-2 border-b border-slate-700/30 hover:bg-slate-800/40 transition-all cursor-pointer">
        <div class="quest-icon-box w-10 h-10 rounded-xl bg-slate-900 flex items-center justify-center shrink-0 border border-slate-700 shadow-lg group-hover:scale-105 transition-transform">
            <span class="material-symbols-rounded text-xl quest-icon text-slate-400">task</span>
        </div>
        <div class="flex-1 min-w-0 flex flex-col gap-1.5">
            <div class="flex justify-between items-end px-1">
                <span class="quest-desc text-xs font-bold text-amber-400 truncate" style="font-family: 'Amiri', serif;">عنوان المهمة</span>
                <span class="quest-progress-text text-[10px] font-bold text-cyan-400 font-mono tracking-wider">0/10</span>
            </div>
            <div class="glass-tube-container w-full h-4">
                <div class="quest-progress-bar liquid-fill"></div>
            </div>
        </div>
        <div class="quest-action shrink-0 w-8 flex justify-center items-center">
        </div>
    </div>
</template>
<template id="notif-template"><div class="notif-item p-3 flex gap-3 border-l-2 transition-all"><div class="mt-1"><span class="notif-icon material-symbols-rounded text-lg"></span></div><div class="flex-1"><p class="notif-title text-xs font-bold text-slate-200 mb-0.5"></p><p class="notif-body text-[10px] text-slate-400 leading-relaxed"></p><p class="notif-date text-[9px] text-slate-600 mt-1 text-left" dir="ltr"></p></div></div></template>
<template id="selection-item-template"><div class="selection-item !flex-col !items-stretch !gap-1 !py-2 cursor-pointer hover:bg-white/5 rounded-lg px-2 transition-colors"><div class="flex justify-between w-full items-center"><div class="flex items-center gap-2"><span class="item-text text-base leading-tight"></span><span class="verified-icon material-symbols-rounded text-green-400 text-[10px] hidden" title="مختوم">verified</span></div><span class="material-symbols-rounded text-slate-500 text-sm">chevron_left</span></div><div class="progress-section w-full mt-0.5 px-0.5 hidden"><div class="flex justify-between text-[9px] text-slate-400 mb-0.5 font-mono leading-none"><span class="opacity-70">المعرفة</span><span class="progress-text text-amber-500" dir="ltr"></span></div><div class="h-1 w-full bg-slate-900/60 rounded-full overflow-hidden border border-slate-700/30"><div class="progress-bar h-full bg-amber-500 transition-all duration-1000 relative" style="width: 0%"><div class="shine-effect absolute inset-0 bg-white/30 animate-pulse hidden"></div></div></div></div></div></template>
<template id="badge-card-template"><div class="badge-card flex p-3 mb-2 rounded-xl border transition-all duration-300 relative overflow-hidden group bg-slate-800/40 border-slate-700"><div class="flex flex-col items-center justify-center gap-1 ml-3 shrink-0" style="min-width:60px"><div class="badge-icon-box relative w-12 h-12 rounded-full border-2 bg-black flex items-center justify-center transition-transform duration-300 group-hover:scale-110"><span class="badge-icon material-symbols-rounded text-3xl">star</span>
</div></div><div class="badge-info flex flex-col justify-center h-full w-full"><div class="flex justify-between items-center mb-1"><div class="flex flex-col"><h4 class="badge-name font-bold text-white text-sm leading-tight"></h4><span class="badge-tier text-[10px] font-bold opacity-90"></span></div><div class="flex flex-col items-end gap-1"><div class="bg-slate-900/50 px-2 py-0.5 rounded text-[10px] border border-white/5 shrink-0"><span class="badge-progress-text text-amber-400 font-bold" dir="ltr"></span></div></div></div><p class="badge-desc text-[10px] text-slate-400 mb-2 leading-tight opacity-80 pl-1"></p><div class="badge-rewards flex justify-between items-center mb-1"></div><div class="badge-track h-1.5 w-full bg-white/5 rounded-full overflow-hidden"><div class="badge-bar h-full transition-all duration-1000"></div></div></div></div></template>
<template id="review-card-template"><div class="review-item text-sm p-3 rounded-lg border mb-3 transition-colors"><p class="rev-q text-white font-bold mb-1 leading-relaxed"></p><div class="rev-opts space-y-1"></div><p class="rev-ans text-sm text-green-400 mt-2 pt-1 border-t border-red-800/50 hidden"></p></div></template>
<template id="game-item-template"><button class="game-item-card relative flex flex-col items-center justify-between p-3 rounded-xl bg-slate-800/80 border border-slate-700 hover:border-amber-500/50 hover:bg-slate-700 transition-all group h-full"><div class="item-preview w-12 h-12 relative mb-2 transition-transform group-hover:scale-110"></div><span class="item-name text-[10px] font-bold text-slate-300 group-hover:text-white text-center leading-tight mb-2"></span><div class="item-action mt-auto w-full flex justify-center"></div></button></template>
<template id="fav-item-template"><div class="fav-item p-3 bg-slate-800/50 rounded-xl border border-slate-700 mb-2 flex justify-between items-center gap-3 hover:border-amber-500/30 transition-all"><div class="overflow-hidden flex-1"><p class="fav-q text-amber-400 text-sm font-bold mb-1 truncate"></p><p class="fav-a text-[10px] text-slate-400 truncate"></p></div><button class="fav-del-btn text-red-400 hover:text-red-300 p-2 transition bg-red-500/10 rounded-lg hover:bg-red-500/20 shrink-0"><span class="material-symbols-rounded text-lg">delete</span></button></div></template>
<template id="mini-badge-template">
    <div class="mini-badge flex flex-col items-center gap-2 group cursor-pointer w-full p-1 rounded-lg hover:bg-white/5 transition-colors">
        <div class="badge-ring relative w-12 h-12 rounded-full border-2 bg-slate-800 transition-transform duration-300 group-hover:scale-110 flex items-center justify-center shadow-lg">
            <span class="badge-icon material-symbols-rounded text-2xl">star</span>
        </div>
        <div class="text-center w-full">
            <span class="badge-name block text-[10px] text-slate-200 font-bold leading-tight truncate px-1"></span>
            <span class="badge-tier block text-[9px] font-mono mt-0.5 opacity-80"></span>
        </div>
    </div>
</template>
<template id="toast-template"><div class="toast-box fixed top-6 left-1/2 -translate-x-1/2 z-[100] flex items-center gap-3 px-5 py-3 rounded-full shadow-[0_10px_40px_rgba(0,0,0,0.5)] border border-white/10 backdrop-blur-xl transition-all duration-500 transform translate-y-[-150%] opacity-0"><div class="toast-icon-box w-8 h-8 rounded-full flex items-center justify-center shrink-0 bg-white/10"><span class="toast-icon material-symbols-rounded text-lg">info</span></div><span class="toast-msg text-sm font-bold text-white tracking-wide"></span></div></template>
<template id="book-item-template"><div class="book-card relative group cursor-pointer flex flex-col gap-2"><div class="cover-box relative aspect-[2/3] rounded-xl overflow-hidden border border-slate-700 shadow-lg group-hover:border-amber-500/50 group-hover:shadow-[0_0_15px_rgba(245,158,11,0.2)] transition-all duration-300"><img class="book-img w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy"><div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"><span class="material-symbols-rounded text-amber-400 text-3xl drop-shadow-lg scale-0 group-hover:scale-100 transition-transform duration-300">menu_book</span></div></div><h4 class="book-title text-[10px] font-bold text-center text-slate-300 group-hover:text-white transition-colors line-clamp-1"></h4></div></template>
<template id="audio-item-template"><div class="audio-item flex items-center justify-between p-3 bg-slate-800/50 rounded-xl border border-slate-700 mb-2 hover:border-amber-500/50 hover:bg-slate-800 transition-all cursor-pointer group active:scale-[0.98]"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-slate-900 border border-slate-600 flex items-center justify-center shrink-0 group-hover:border-amber-500 transition-colors relative"><span class="material-symbols-rounded text-slate-400 group-hover:text-amber-400 text-xl audio-icon transition-transform">play_arrow</span></div><div><h4 class="audio-title text-xs font-bold text-slate-200 group-hover:text-white leading-tight"></h4><span class="text-[9px] text-slate-500">مقطع صوتي</span></div></div><div class="audio-wave flex gap-0.5 items-end h-3 opacity-0 transition-opacity"><span class="w-0.5 h-full bg-amber-500 animate-[bounce_1s_infinite]"></span><span class="w-0.5 h-2/3 bg-amber-500 animate-[bounce_1.2s_infinite]"></span><span class="w-0.5 h-full bg-amber-500 animate-[bounce_0.8s_infinite]"></span></div></div></template>
<button id="chat-float-bubble" class="hidden fixed top-4 left-4 z-[999] w-14 h-14 rounded-full bg-emerald-500/20 border border-emerald-500/40 backdrop-blur shadow-xl flex items-center justify-center active:scale-95 transition">
    <span class="material-symbols-rounded text-2xl text-emerald-300">chat</span>
    <span id="chat-float-badge" class="hidden absolute -top-1 -right-1">
        <span class="absolute inline-flex w-4 h-4 rounded-full bg-red-500 opacity-60 chat-badge-ping"></span>
        <span class="relative inline-flex w-4 h-4 rounded-full bg-red-500 border-2 border-slate-900 chat-badge-blink"></span>
    </span>
</button>
    <div id="chat-page" class="hidden fixed inset-0 z-[1000] bg-slate-950/95 backdrop-blur">
        <div class="h-full w-full max-w-md mx-auto flex flex-col">
            <div class="shrink-0 px-4 py-3 border-b border-slate-700/60 bg-slate-900/60 flex items-center gap-3">
                <button id="chat-back" class="w-10 h-10 rounded-full hover:bg-white/5 active:scale-95 transition flex items-center justify-center">
                    <span class="material-symbols-rounded">arrow_back</span>
                </button>
                <div class="flex flex-col">
                    <div class="font-bold text-slate-100 leading-tight">مراسلة</div>
                    <div id="chat-header-user" class="text-xs text-slate-400">المطور</div>
                </div>
                <div class="mr-auto"></div>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto px-3 py-4 space-y-3 custom-scrollbar"></div>
            <div class="shrink-0 p-3 border-t border-slate-700/60 bg-slate-900/60">
                <div class="flex items-end gap-2">
                    <textarea id="chat-input" rows="1" class="flex-1 resize-none bg-slate-800/70 border border-slate-700 rounded-2xl px-3 py-2 text-sm outline-none focus:border-emerald-500/50 max-h-32" placeholder="اكتب رسالتك..."></textarea>
                    <button id="chat-send" class="w-11 h-11 rounded-2xl bg-emerald-500/20 border border-emerald-500/40 flex items-center justify-center active:scale-95 transition">
                        <span class="material-symbols-rounded text-emerald-300">send</span>
                    </button>
                </div>
                <div class="mt-2 text-[10px] text-slate-500 text-right">اكتب مشكلتك بدقة✓ </div>
            </div>
        </div>
    </div>
<div id="offline-banner" class="hidden fixed top-4 right-4 z-[200] w-10 h-10 rounded-full bg-red-900/90 text-white border border-red-500 backdrop-blur-sm shadow-lg pointer-events-none transition-transform duration-300 transform -translate-y-20">
    <span class="material-symbols-rounded text-[22px] leading-none">wifi_off</span>
</div>

<!-- نافذة اختيار عدد الأسئلة للتحدي -->
<div id="challenge-setup-modal" class="modal-overlay">
    <div class="modal-box border-2 border-orange-500/50 bg-[#0f172a]">
        <h3 class="text-2xl font-bold text-white mb-4 font-heading text-center">إعداد التحدي</h3>
        <p class="text-slate-300 text-center mb-3">اختر نوع الأسئلة:</p>
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button class="challenge-bank-btn bg-slate-800 text-white py-3 rounded-xl border border-slate-700 hover:border-orange-500/40 hover:bg-slate-700 transition font-heading text-base" data-bank="random_all">عشوائي شامل</button>
            <button class="challenge-bank-btn bg-slate-800 text-white py-3 rounded-xl border border-slate-700 hover:border-orange-500/40 hover:bg-slate-700 transition font-heading text-base" data-bank="general_info">معلومات عامة</button>
            <button class="challenge-bank-btn bg-slate-800 text-white py-3 rounded-xl border border-slate-700 hover:border-orange-500/40 hover:bg-slate-700 transition font-heading text-base" data-bank="dataNooR">أكمل النور</button>
            <button class="challenge-bank-btn bg-slate-800 text-white py-3 rounded-xl border border-slate-700 hover:border-orange-500/40 hover:bg-slate-700 transition font-heading text-base" data-bank="truefalse">صح وخطأ</button>
        </div>
        <p class="text-slate-300 text-center mb-6">اختر عدد الأسئلة للجولة:</p>
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button class="challenge-opt-btn bg-slate-800 text-white py-4 rounded-xl border border-slate-700 hover:border-orange-500/40 hover:bg-slate-700 transition font-heading text-xl" data-count="10">10</button>
            <button class="challenge-opt-btn bg-slate-800 text-white py-4 rounded-xl border border-slate-700 hover:border-orange-500/40 hover:bg-slate-700 transition font-heading text-xl" data-count="15">15</button>
            <button class="challenge-opt-btn bg-slate-800 text-white py-4 rounded-xl border border-slate-700 hover:border-orange-500/40 hover:bg-slate-700 transition font-heading text-xl" data-count="20">20</button>
            <button class="challenge-opt-btn bg-slate-800 text-white py-4 rounded-xl border border-slate-700 hover:border-orange-500/40 hover:bg-slate-700 transition font-heading text-xl" data-count="30">30</button>
        </div>
        <button class="close-modal w-full text-slate-500 hover:text-white text-sm transition">إلغاء</button>
    </div>
</div>

<!-- نافذة انتظار قبول التحدي -->
<div id="challenge-waiting-modal" class="modal-overlay">
    <div class="modal-box border-2 border-amber-500/50 bg-[#0f172a] text-center">
        <div class="mb-6">
            <div class="w-20 h-20 rounded-full bg-amber-500/10 flex items-center justify-center mx-auto border-2 border-amber-500/30 animate-pulse">
                <span class="material-symbols-rounded text-4xl text-amber-400">hourglass_empty</span>
            </div>
        </div>
        <h3 class="text-xl font-bold text-white mb-2 font-heading">في انتظار الخصم...</h3>
        <p id="challenge-waiting-details" class="text-slate-300 text-sm mb-2"></p>
        <p class="text-slate-400 text-sm mb-6">تنتهي الدعوة خلال <span id="challenge-timer" class="text-orange-400 font-bold">60</span> ثانية</p>
        <button id="btn-cancel-challenge" class="w-full py-3 rounded-xl bg-slate-800 text-red-400 border border-red-500/30 hover:bg-red-500/10 transition">إلغاء الدعوة</button>
    </div>
</div>

<!-- نافذة استقبال التحدي -->
<div id="challenge-receive-modal" class="modal-overlay">
    <div class="modal-box border-2 border-orange-500/50 bg-[#0f172a] text-center">
        <div class="mb-6">
            <div id="challenge-receive-avatar" class="w-20 h-20 rounded-full bg-orange-500/10 flex items-center justify-center mx-auto border-2 border-orange-500/30">
                <span class="material-symbols-rounded text-4xl text-orange-400">swords</span>
            </div>
        </div>
        <h3 id="challenge-receive-text" class="text-xl font-bold text-white mb-6 font-heading">فلان يتحداك!</h3>
        <div class="flex gap-3">
            <button id="btn-accept-challenge" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-green-600 to-emerald-500 text-white font-bold shadow-lg">قبول</button>
            <button id="btn-reject-challenge" class="flex-1 py-3 rounded-xl bg-slate-800 text-red-400 border border-red-500/30">رفض</button>
        </div>
        <p class="text-slate-500 text-[10px] mt-4">تنتهي الدعوة تلقائياً خلال <span id="receive-timer">60</span> ثانية</p>
    </div>
</div>

<!-- واجهة التحدي (المباراة) -->
<div id="challenge-match-view" class="hidden fixed inset-0 z-[150] bg-[#0f172a] flex flex-col">
    <!-- هيدر المباراة -->
    <div class="p-4 border-b border-white/5 bg-slate-900/50 flex flex-col gap-4">
        <!-- أنابيب التقدم -->
        <div class="space-y-3">
            <!-- تقدمي -->
            <div>
                <div class="flex justify-between text-[10px] mb-1 px-1">
                    <span class="text-emerald-400 font-bold">أنا (أنت)</span>
                    <span id="my-challenge-progress-text" class="text-white font-mono">0/0</span>
                </div>
                <div class="h-2 bg-slate-800 rounded-full overflow-hidden border border-white/5">
                    <div id="my-challenge-progress-fill" class="h-full w-0 bg-gradient-to-r from-emerald-600 to-emerald-400 transition-all duration-300"></div>
                </div>
            </div>
            <!-- تقدم الخصم -->
            <div>
                <div class="flex justify-between text-[10px] mb-1 px-1">
                    <span id="opponent-name-label" class="text-orange-400 font-bold">الخصم</span>
                    <span id="opponent-challenge-progress-text" class="text-white font-mono">0/0</span>
                </div>
                <div class="h-2 bg-slate-800 rounded-full overflow-hidden border border-white/5">
                    <div id="opponent-challenge-progress-fill" class="h-full w-0 bg-gradient-to-r from-orange-600 to-orange-400 transition-all duration-300"></div>
                </div>
            </div>
        </div>
        
        <!-- القلوب والنتيجة -->
        <div class="flex justify-between items-center">
            <div id="my-challenge-lives" class="flex gap-1">
                <!-- قلوب ستضاف برمجياً -->
            </div>
            <div class="text-center">
                <span id="challenge-match-score" class="text-2xl font-bold text-amber-400 font-mono">0 - 0</span>
            </div>
            <div id="opponent-challenge-lives" class="flex gap-1">
                <!-- قلوب الخصم ستضاف برمجياً -->
            </div>
        </div>
    </div>

    <!-- منطقة السؤال (سنستخدم نفس هيكل quiz-proper برمجياً أو نعيد استخدامه) -->
    <div id="challenge-quiz-area" class="flex-1 overflow-y-auto p-4 flex flex-col justify-center">
        <div id="challenge-question-container" class="bg-slate-800/40 border border-white/5 rounded-3xl p-6 mb-6 min-h-[150px] flex items-center justify-center text-center relative">
            <div id="challenge-question-topic" class="absolute top-3 right-4 left-4 text-[11px] text-slate-400 font-bold"></div>
            <p id="challenge-question-text" class="text-xl font-bold text-white leading-relaxed"></p>
        </div>
        <div id="challenge-options-container" class="space-y-3">
            <!-- خيارات ستضاف برمجياً -->
        </div>
    </div>

    <!-- تذييل المباراة -->
    <div class="p-4 border-t border-white/5 bg-slate-900/50">
        <button id="btn-quit-challenge" class="w-full py-3 text-slate-500 hover:text-red-400 transition text-sm flex items-center justify-center gap-2">
            <span class="material-symbols-rounded text-lg">logout</span>
            انسحاب من التحدي
        </button>
    </div>
</div>

<!-- نافذة نتيجة التحدي -->
<div id="challenge-result-modal" class="modal-overlay">
    <div class="modal-box border-2 border-amber-500/50 bg-[#0f172a] text-center">
        <div id="challenge-result-icon" class="mb-4">
            <!-- أيقونة فوز/خسارة -->
        </div>
        <h2 id="challenge-result-title" class="text-3xl font-bold text-white mb-2 font-heading">فزت!</h2>
        <p id="challenge-result-reason" class="text-amber-400 text-sm mb-6 font-bold"></p>
        
        <div class="bg-slate-800/60 rounded-2xl p-4 border border-white/5 mb-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center">
                    <p class="text-[10px] text-slate-400 mb-1">نتيجتك</p>
                    <p id="my-final-result" class="text-xl font-bold text-emerald-400 font-mono">0/0</p>
                </div>
                <div class="text-center border-r border-white/10">
                    <p class="text-[10px] text-slate-400 mb-1">نتيجة الخصم</p>
                    <p id="opponent-final-result" class="text-xl font-bold text-orange-400 font-mono">0/0</p>
                </div>
            </div>
        </div>
        
        <button id="btn-close-challenge-result" class="btn-gold-action w-full py-3">العودة للرئيسية</button>
    </div>
</div>
</body>
</html>
